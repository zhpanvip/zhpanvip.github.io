

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>Android Widget开发详解 - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_6peoq002giu.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.1.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>zhangpan</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2018-06-21 13:35" pubdate>
      2018年6月21日 下午
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.9k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      55
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Android Widget开发详解</h1>
            
            <div class="markdown-body" id="post-body">
              <p>好久没博客更新了，本篇文章来学习一下如何实现一个Android列表小部件，效果可以参看下图：<br><img src="https://raw.githubusercontent.com/zhpanvip/Resource/master/image/1303.gif" srcset="/img/loading.gif"></p>
<p>这个页面如果是在App内部实现，相信只要有一点Android基础的童鞋都能很轻松写出来。但是如果放到Widget中可能就不是那么简单了。因为Widget并没有运行在我们App的进程中，而是运行在系统的SystemServer进程中。你可能会惊讶，Whf！竟然不在我们App进程中！那么是不是意味着我们也不能像在App中那样操作View控件了？答案确实如此。不过不必过于担心，为了我们能在远程进程中更新界面，Google爸爸专门为我们提供了一个RemoteViews类。从名字上看，可能会觉得RemoteViews就是一个View。但事实并非如此，RemoteViews仅仅表示的是一个View结构。它可以在远程进程中展示和更新界面。今天我们要实现的列表小部件就是基于RemoteVeiw实现的。<br>那么接下来我们来学习如何实现一个桌面Widget，我们先列出要实现Widget的几个核心步骤：</p>
<ul>
<li>widget页面布局  </li>
<li>小部件配置信息 </li>
<li>了解AppWidgetProvider</li>
<li>RemoteViewsFactory实现列表适配</li>
<li>点击的事件处理</li>
</ul>
<h2 id="一-实现Widget界面"><a href="#一-实现Widget界面" class="headerlink" title="一. 实现Widget界面"></a>一. 实现Widget界面</h2><p><strong>1.widget页面布局。</strong>首先创建一个布局文件layout_widget.xml，内容如下：</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/ll_right&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;@drawable/bg_widget&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">RelativeLayout</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;40dp&quot;</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;#ccc&quot;</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/iv_icon&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;30dp&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;30dp&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_centerVertical</span>=<span class="hljs-string">&quot;true&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_marginEnd</span>=<span class="hljs-string">&quot;5dp&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_marginStart</span>=<span class="hljs-string">&quot;5dp&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;@mipmap/ic_launcher_round&quot;</span> /&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/tv_title&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_centerVertical</span>=<span class="hljs-string">&quot;true&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_toEndOf</span>=<span class="hljs-string">&quot;@id/iv_icon&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;Widget&quot;</span> /&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:layout_alignParentEnd</span>=<span class="hljs-string">&quot;true&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center_vertical&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;horizontal&quot;</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">ProgressBar</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/progress_bar&quot;</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;20dp&quot;</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;20dp&quot;</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:indeterminateTint</span>=<span class="hljs-string">&quot;@color/colorAccent&quot;</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:indeterminateTintMode</span>=<span class="hljs-string">&quot;src_atop&quot;</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:visibility</span>=<span class="hljs-string">&quot;gone&quot;</span> /&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/tv_refresh&quot;</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:layout_marginEnd</span>=<span class="hljs-string">&quot;15dp&quot;</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;刷新&quot;</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:padding</span>=<span class="hljs-string">&quot;5dp&quot;</span></span>
<span class="hljs-tag">                <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;12sp&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">RelativeLayout</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">ListView</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/lv_device&quot;</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:columnWidth</span>=<span class="hljs-string">&quot;80dip&quot;</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">&quot;center&quot;</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:horizontalSpacing</span>=<span class="hljs-string">&quot;4dip&quot;</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:numColumns</span>=<span class="hljs-string">&quot;auto_fit&quot;</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:verticalSpacing</span>=<span class="hljs-string">&quot;4dip&quot;</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span></code></pre>
<p>看到布局中的ListView控件，你可能会不屑一笑，都什么年代了还在用ListView？RecyclerView才是王道吧？可是我只能说句抱歉，Widget不支持RecyclerView。对，你没看错，真的不支持。在Widget中我们没办法做到想用什么就用什么，甚至觉得原生用着不爽，自己撸一个控件出来。对不起，Widget都不支持。因此Widget也有很大的局限性。我们来看下支持在Widget中运行的有哪些控件：</p>
<blockquote>
<p>A RemoteViews object (and, consequently, an App Widget) can support the following layout classes:<br>FrameLayout<br>LinearLayout<br>RelativeLayout<br>GridLayout<br>And the following widget classes:<br>AnalogClock<br>Button<br>Chronometer<br>ImageButton<br>ImageView<br>ProgressBar<br>TextView<br>ViewFlipper<br>ListView<br>GridView<br>StackView<br>AdapterViewFlipper<br>Descendants of these classes are not supported.</p>
</blockquote>
<p>除了上述列出的几个View，其它的包括Android原生View和自定义View是都不支持在Widget中运行的。因此基于Widget页面限制我们基本就可以告别炫酷的动画效果了。</p>
<h2 id="二-小部件配置信息"><a href="#二-小部件配置信息" class="headerlink" title="二.小部件配置信息"></a>二.小部件配置信息</h2><p>配置信息主要是设定小部件的一些属性，比如宽高、缩放模式、更新时间间隔等。我们需要在res/xml目录下新建widget_provider.xml文件，文件名字可以任意取。文件内容如下（可做参考）：</p>
<pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">appwidget-provider</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:minHeight</span>=<span class="hljs-string">&quot;180dp&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:minWidth</span>=<span class="hljs-string">&quot;300dp&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:previewImage</span>=<span class="hljs-string">&quot;@drawable/ic_launcher_background&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:initialLayout</span>=<span class="hljs-string">&quot;@layout/layout_widget&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:updatePeriodMillis</span>=<span class="hljs-string">&quot;50000&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:resizeMode</span>=<span class="hljs-string">&quot;horizontal|vertical&quot;</span></span>
<span class="hljs-tag">    <span class="hljs-attr">android:widgetCategory</span>=<span class="hljs-string">&quot;home_screen&quot;</span>&gt;</span> 
    
<span class="hljs-tag">&lt;/<span class="hljs-name">appwidget-provider</span>&gt;</span></code></pre>
<p>针对上述文件中的配置信息来做下介绍。</p>
<ul>
<li><strong><em>minHeight、minWidth</em></strong> 定义Widget的最小高度和最小宽度（Widget可以通过拉伸来调整尺寸大小）。</li>
<li><strong><em>previewImage</em></strong> 定义添加小部件时显示的图标。</li>
<li><strong><em>initialLayout</em></strong> 定义了小部件使用的布局。</li>
<li><strong><em>updatePeriodMillis</em></strong>定义小部件自动更新的周期，单位为毫秒。</li>
<li><strong><em>resizeMode</em></strong> 指定了 widget 的调整尺寸的规则。可取的值有: “horizontal”, “vertical”, “none”。”horizontal”意味着widget可以水平拉伸，“vertical”意味着widget可以竖值拉伸，“none”意味着widget不能拉伸；默认值是”none”。</li>
<li><strong><em>widgetCategory</em></strong> 指定了 widget 能显示的地方：能否显示在 home Screen 或 lock screen 或 两者都可以。它的取值包括：”home_screen” 和 “keyguard”。Android 4.2 引入。<br>最后，需要我们在AndroidManifest中注册AppWidgetProvider时引用该文件，使用如下：</li>
</ul>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">receiver</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.widget.ListWidgetProvider&quot;</span>&gt;</span>
     ...
    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.appwidget.provider&quot;</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:resource</span>=<span class="hljs-string">&quot;@xml/widget_provider&quot;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">receiver</span>&gt;</span></code></pre>

<h2 id="三-了解AppWidgetProvider类"><a href="#三-了解AppWidgetProvider类" class="headerlink" title="三.了解AppWidgetProvider类"></a>三.了解AppWidgetProvider类</h2><p>我们来简单了解下AppWidgetProvider这个类。Widget的功能均是通过AppWidgetProvider来实现的。我们跟进源码可以发现它是继承自BroadcastReceiver类，也就是一个广播接收者。上面我们提到过RemoteViews是运行在SystemServer进程中的，再结合此处我们应该可以推测小部件的事件应该是通过广播来实现的。像小部件的添加、删除、更新、启用、禁用等均是在AppWidgetProvider中通过接受广播来完成的。看AppWidgetProvider中的几个方法：</p>
<ul>
<li>onUpdate() 当Widget被添加或者被更新时会调用该方法。上边我们提到通过配置updatePeriodMillis可以定期更新Widget。但是当我们在widget的配置文件中声明了android:configure的时候，添加Widget时则不会调用onUpdate方法。</li>
<li>onEnable() 这个方法会在用户首次添加Widget时调用。</li>
<li>onAppWidgetOptionsChanged() 这个方法会在添加Widget或者改变Widget的大小时候被调用。在这个方法中我们还可以根据Widget的大小来选择性的显示或隐藏某些控件。</li>
<li>onDeleted(Context, int[]) 当控件被删除的时候调用该方法</li>
<li>onEnabled(Context) 当第一个Widget被添加的时候调用。如果用户添加了两个这个小部件，那么只有第一个添加时才会调用onEnabled.</li>
<li>onDisabled(Context) 当最后一个Widget实例被移除的时候调用这个方法。在这个方法中我们可以做一些清除工作，例如删掉临时的数据库等。</li>
<li>onReceive(Context, Intent) 当接收到广播的时候会被调用。</li>
</ul>
<p>上述方法中，我们需要着重关心一下onUpdate()方法和onReceive()方法。因为onUpdate()方法会在Widget被添加时候调用，我们可以在此时为Widget添加一View的些交互事件，例如点击事件。由于本篇我们要实现的是一个列表小部件。因此我们还需要RemoteViewsFactory这个类来适配列表数据。</p>
<p>先来看下ListWidgetProvider这个类中的代码：</p>
<pre><code class="hljs arduino"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListWidgetProvider</span> <span class="hljs-title">extends</span> <span class="hljs-title">AppWidgetProvider</span> &#123;</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> TAG = <span class="hljs-string">&quot;WIDGET&quot;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> REFRESH_WIDGET = <span class="hljs-string">&quot;com.oitsme.REFRESH_WIDGET&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> COLLECTION_VIEW_ACTION = <span class="hljs-string">&quot;com.oitsme.COLLECTION_VIEW_ACTION&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> COLLECTION_VIEW_EXTRA = <span class="hljs-string">&quot;com.oitsme.COLLECTION_VIEW_EXTRA&quot;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Handler mHandler=<span class="hljs-keyword">new</span> Handler();
    <span class="hljs-keyword">private</span> Runnable runnable=<span class="hljs-keyword">new</span> Runnable() &#123;
        @Override
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-built_in">run</span>() &#123;
            hideLoading(Utils.getContext());
            Toast.makeText(Utils.getContext(), <span class="hljs-string">&quot;刷新成功&quot;</span>, Toast.LENGTH_SHORT).show();
        &#125;
    &#125;;

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onUpdate</span><span class="hljs-params">(Context context, AppWidgetManager appWidgetManager,</span></span>
<span class="hljs-function"><span class="hljs-params">                         <span class="hljs-keyword">int</span>[] appWidgetIds)</span> </span>&#123;

        Log.d(TAG, <span class="hljs-string">&quot;ListWidgetProvider onUpdate&quot;</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> appWidgetId : appWidgetIds) &#123;
            <span class="hljs-comment">// 获取AppWidget对应的视图</span>
            RemoteViews remoteViews = <span class="hljs-keyword">new</span> RemoteViews(context.getPackageName(), R.layout.layout_widget);

            <span class="hljs-comment">// 设置响应 “按钮(bt_refresh)” 的intent</span>
            Intent btIntent = <span class="hljs-keyword">new</span> Intent().setAction(REFRESH_WIDGET);
            PendingIntent btPendingIntent = PendingIntent.getBroadcast(context, <span class="hljs-number">0</span>, btIntent, PendingIntent.FLAG_UPDATE_CURRENT);
            remoteViews.setOnClickPendingIntent(R.id.tv_refresh, btPendingIntent);

            <span class="hljs-comment">// 设置 “ListView” 的adapter。</span>
            <span class="hljs-comment">// (01) intent: 对应启动 ListWidgetService(RemoteViewsService) 的intent</span>
            <span class="hljs-comment">// (02) setRemoteAdapter: 设置 gridview的适配器</span>
            <span class="hljs-comment">//    通过setRemoteAdapter将ListView和ListWidgetService关联起来，</span>
            <span class="hljs-comment">//    以达到通过 ListWidgetService 更新 ListView的目的</span>
            Intent serviceIntent = <span class="hljs-keyword">new</span> Intent(context, ListWidgetService.class);
            remoteViews.setRemoteAdapter(R.id.lv_device, serviceIntent);


            <span class="hljs-comment">// 设置响应 “ListView” 的intent模板</span>
            <span class="hljs-comment">// 说明：“集合控件(如GridView、ListView、StackView等)”中包含很多子元素，如GridView包含很多格子。</span>
            <span class="hljs-comment">//     它们不能像普通的按钮一样通过 setOnClickPendingIntent 设置点击事件，必须先通过两步。</span>
            <span class="hljs-comment">//        (01) 通过 setPendingIntentTemplate 设置 “intent模板”，这是比不可少的！</span>
            <span class="hljs-comment">//        (02) 然后在处理该“集合控件”的RemoteViewsFactory类的getViewAt()接口中 通过 setOnClickFillInIntent 设置“集合控件的某一项的数据”</span>
            Intent gridIntent = <span class="hljs-keyword">new</span> Intent();

            gridIntent.setAction(COLLECTION_VIEW_ACTION);
            gridIntent.putExtra(AppWidgetManager.EXTRA_APPWIDGET_ID, appWidgetId);
            PendingIntent pendingIntent = PendingIntent.getBroadcast(context, <span class="hljs-number">0</span>, gridIntent, PendingIntent.FLAG_UPDATE_CURRENT);
            <span class="hljs-comment">// 设置intent模板</span>
            remoteViews.setPendingIntentTemplate(R.id.lv_device, pendingIntent);
            <span class="hljs-comment">// 调用集合管理器对集合进行更新</span>
            appWidgetManager.updateAppWidget(appWidgetId, remoteViews);
        &#125;
        super.onUpdate(context, appWidgetManager, appWidgetIds);
    &#125;


    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> </span>&#123;
        <span class="hljs-keyword">String</span> action = intent.getAction();
        AppWidgetManager appWidgetManager = AppWidgetManager.getInstance(context);
        <span class="hljs-keyword">if</span> (action.equals(COLLECTION_VIEW_ACTION)) &#123;
            <span class="hljs-comment">// 接受“ListView”的点击事件的广播</span>
            <span class="hljs-keyword">int</span> type = intent.getIntExtra(<span class="hljs-string">&quot;Type&quot;</span>, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">int</span> appWidgetId = intent.getIntExtra(AppWidgetManager.EXTRA_APPWIDGET_ID,
                    AppWidgetManager.INVALID_APPWIDGET_ID);
            <span class="hljs-keyword">int</span> index = intent.getIntExtra(COLLECTION_VIEW_EXTRA, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">switch</span> (type) &#123;
                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
                    Toast.makeText(context, <span class="hljs-string">&quot;item&quot;</span> + index, Toast.LENGTH_SHORT).show();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                    Toast.makeText(context, <span class="hljs-string">&quot;lock&quot;</span>+index, Toast.LENGTH_SHORT).show();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                    Toast.makeText(context, <span class="hljs-string">&quot;unlock&quot;</span>+index, Toast.LENGTH_SHORT).show();
                    <span class="hljs-keyword">break</span>;
            &#125;
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action.equals(REFRESH_WIDGET)) &#123;
            <span class="hljs-comment">// 接受“bt_refresh”的点击事件的广播</span>
            Toast.makeText(context, <span class="hljs-string">&quot;刷新...&quot;</span>, Toast.LENGTH_SHORT).show();
            <span class="hljs-keyword">final</span> AppWidgetManager mgr = AppWidgetManager.getInstance(context);
            <span class="hljs-keyword">final</span> ComponentName cn = <span class="hljs-keyword">new</span> ComponentName(context,ListWidgetProvider.class);
            ListRemoteViewsFactory.refresh();
            mgr.notifyAppWidgetViewDataChanged(mgr.getAppWidgetIds(cn),R.id.lv_device);
            mHandler.postDelayed(runnable,<span class="hljs-number">2000</span>);
            showLoading(context);
        &#125;
        super.<span class="hljs-built_in">onReceive</span>(context, intent);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 显示加载loading</span>
<span class="hljs-comment">     *</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">showLoading</span><span class="hljs-params">(Context context)</span> </span>&#123;
        RemoteViews remoteViews = <span class="hljs-keyword">new</span> RemoteViews(context.getPackageName(), R.layout.layout_widget);
        remoteViews.setViewVisibility(R.id.tv_refresh, View.VISIBLE);
        remoteViews.setViewVisibility(R.id.progress_bar, View.VISIBLE);
        remoteViews.setTextViewText(R.id.tv_refresh, <span class="hljs-string">&quot;正在刷新...&quot;</span>);
        refreshWidget(context, remoteViews, <span class="hljs-literal">false</span>);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 隐藏加载loading</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hideLoading</span><span class="hljs-params">(Context context)</span> </span>&#123;
        RemoteViews remoteViews = <span class="hljs-keyword">new</span> RemoteViews(context.getPackageName(), R.layout.layout_widget);
        remoteViews.setViewVisibility(R.id.progress_bar, View.GONE);
        remoteViews.setTextViewText(R.id.tv_refresh, <span class="hljs-string">&quot;刷新&quot;</span>);
        refreshWidget(context, remoteViews, <span class="hljs-literal">false</span>);
    &#125;



    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 刷新Widget</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refreshWidget</span><span class="hljs-params">(Context context, RemoteViews remoteViews, <span class="hljs-keyword">boolean</span> refreshList)</span> </span>&#123;
        AppWidgetManager appWidgetManager = AppWidgetManager.getInstance(context);
        ComponentName componentName = <span class="hljs-keyword">new</span> ComponentName(context, ListWidgetProvider.class);
        appWidgetManager.updateAppWidget(componentName, remoteViews);
        <span class="hljs-keyword">if</span> (refreshList)
            appWidgetManager.notifyAppWidgetViewDataChanged(appWidgetManager.getAppWidgetIds(componentName), R.id.lv_device);
    &#125;
&#125;</code></pre>
<p>针对以上代码，我们着重来看onUpdate()方法。在onUpdate()中我们主要实现了两个功能，第一个功能ListView以外的事件点击，例如点击“刷新”来更新小部件。第二个功能是适配ListView并实现ListView内部Item控件的点击事件。在这个方法中我们首先获取到了一个RemoteView的实例，这个RemoteView对应的就是我们Widget布局的View。关于点击事件的实现代码中注释写的也比较详细，在这里就不做过多解释了。重点是需要了解如何实现并适配ListView，具体实现请看下节。</p>
<h2 id="四-RemoteViewsFactory实现列表适配"><a href="#四-RemoteViewsFactory实现列表适配" class="headerlink" title="四.RemoteViewsFactory实现列表适配"></a>四.RemoteViewsFactory实现列表适配</h2><p>上面我们提到了RemoteViewsFactory，这个类其实可以类比为ListView的Adapter，该类存在的意义就是为了适配ListView的数据。只不过这里是把Adapter换成RemoteViews来实现的。看下ListRemoteViewsFactory中的代码：</p>
<pre><code class="hljs arduino"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListRemoteViewsFactory</span> <span class="hljs-title">implements</span> <span class="hljs-title">RemoteViewsService</span>.<span class="hljs-title">RemoteViewsFactory</span> &#123;</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">String</span> TAG=<span class="hljs-string">&quot;Widget&quot;</span>;
    <span class="hljs-keyword">private</span> Context mContext;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> mAppWidgetId;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Device&gt; mDevices;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 构造GridRemoteViewsFactory</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ListRemoteViewsFactory</span><span class="hljs-params">(Context context, Intent intent)</span> </span>&#123;
        mContext = context;
        mAppWidgetId = intent.getIntExtra(AppWidgetManager.EXTRA_APPWIDGET_ID,
                AppWidgetManager.INVALID_APPWIDGET_ID);
    &#125;

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> RemoteViews <span class="hljs-title">getViewAt</span><span class="hljs-params">(<span class="hljs-keyword">int</span> <span class="hljs-built_in">position</span>)</span> </span>&#123;
        <span class="hljs-comment">//  HashMap&lt;String, Object&gt; map;</span>

        <span class="hljs-comment">// 获取 item_widget_device.xml 对应的RemoteViews</span>
        RemoteViews rv = <span class="hljs-keyword">new</span> RemoteViews(mContext.getPackageName(), R.layout.item_widget_device);

        <span class="hljs-comment">// 设置 第position位的“视图”的数据</span>
        Device device = mDevices.<span class="hljs-built_in">get</span>(<span class="hljs-built_in">position</span>);
        <span class="hljs-comment">//  rv.setImageViewResource(R.id.iv_lock, ((Integer) map.get(IMAGE_ITEM)).intValue());</span>
        rv.setTextViewText(R.id.tv_name, device.getName());

        <span class="hljs-comment">// 设置 第position位的“视图”对应的响应事件</span>
        Intent fillInIntent = <span class="hljs-keyword">new</span> Intent();
        fillInIntent.putExtra(<span class="hljs-string">&quot;Type&quot;</span>, <span class="hljs-number">0</span>);
        fillInIntent.putExtra(ListWidgetProvider.COLLECTION_VIEW_EXTRA, <span class="hljs-built_in">position</span>);
        rv.setOnClickFillInIntent(R.id.rl_widget_device, fillInIntent);


        Intent lockIntent = <span class="hljs-keyword">new</span> Intent();
        lockIntent.putExtra(ListWidgetProvider.COLLECTION_VIEW_EXTRA, <span class="hljs-built_in">position</span>);
        lockIntent.putExtra(<span class="hljs-string">&quot;Type&quot;</span>, <span class="hljs-number">1</span>);
        rv.setOnClickFillInIntent(R.id.iv_lock, lockIntent);

        Intent unlockIntent = <span class="hljs-keyword">new</span> Intent();
        unlockIntent.putExtra(<span class="hljs-string">&quot;Type&quot;</span>, <span class="hljs-number">2</span>);
        unlockIntent.putExtra(ListWidgetProvider.COLLECTION_VIEW_EXTRA, <span class="hljs-built_in">position</span>);
        rv.setOnClickFillInIntent(R.id.iv_unlock, unlockIntent);

        <span class="hljs-keyword">return</span> rv;
    &#125;


    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 初始化ListView的数据</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initListViewData</span><span class="hljs-params">()</span> </span>&#123;
        mDevices = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        mDevices.add(<span class="hljs-keyword">new</span> Device(<span class="hljs-string">&quot;Hello&quot;</span>, <span class="hljs-number">0</span>));
        mDevices.add(<span class="hljs-keyword">new</span> Device(<span class="hljs-string">&quot;Oitsme&quot;</span>, <span class="hljs-number">1</span>));
        mDevices.add(<span class="hljs-keyword">new</span> Device(<span class="hljs-string">&quot;Hi&quot;</span>, <span class="hljs-number">0</span>));
        mDevices.add(<span class="hljs-keyword">new</span> Device(<span class="hljs-string">&quot;Hey&quot;</span>, <span class="hljs-number">1</span>));
    &#125;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> i;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refresh</span><span class="hljs-params">()</span></span>&#123;
        i++;
        mDevices.add(<span class="hljs-keyword">new</span> Device(<span class="hljs-string">&quot;Refresh&quot;</span>+i, <span class="hljs-number">1</span>));
    &#125;

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span> </span>&#123;
        Log.e(TAG,<span class="hljs-string">&quot;onCreate&quot;</span>);
        <span class="hljs-comment">// 初始化“集合视图”中的数据</span>
        initListViewData();
    &#125;

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-comment">// 返回“集合视图”中的数据的总数</span>
        <span class="hljs-keyword">return</span> mDevices.<span class="hljs-built_in">size</span>();
    &#125;

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getItemId</span><span class="hljs-params">(<span class="hljs-keyword">int</span> <span class="hljs-built_in">position</span>)</span> </span>&#123;
        <span class="hljs-comment">// 返回当前项在“集合视图”中的位置</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">position</span>;
    &#125;

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> RemoteViews <span class="hljs-title">getLoadingView</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> null;
    &#125;

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getViewTypeCount</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-comment">// 只有一类 ListView</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    &#125;

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasStableIds</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    &#125;

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onDataSetChanged</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span> </span>&#123;
        mDevices.<span class="hljs-built_in">clear</span>();
    &#125;
&#125;</code></pre>
<p>有了RemoteViewsFactory 还需要有RemoteViewsService才能与ListView关联起来。来看RemoteViewsService的实现类ListWidgetService，很简单，只重写了onGetViewFactory方法：</p>
<pre><code class="hljs scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListWidgetService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RemoteViewsService</span> </span>&#123;

    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">RemoteViewsService</span>.<span class="hljs-type">RemoteViewsFactory</span> onGetViewFactory(<span class="hljs-type">Intent</span> intent) &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-type">ListRemoteViewsFactory</span>(<span class="hljs-keyword">this</span>, intent);
    &#125;
&#125;</code></pre>
<p>至此我们可以再次回到ListWidgetProvider中的onUpdate()方法，来看ListWidgetService 是如何与ListView关联到一起的了。</p>
<pre><code class="hljs reasonml"><span class="hljs-comment">//  设置 “ListView” 的adapter。</span>
<span class="hljs-comment">// (01) intent: 对应启动 ListWidgetService(RemoteViewsService) 的intent</span>
<span class="hljs-comment">// (02) setRemoteAdapter: 设置 ListView的适配器</span>
<span class="hljs-comment">//  通过setRemoteAdapter将ListView和ListWidgetService关联起来，</span>
<span class="hljs-comment">//  以达到通过 ListWidgetService 更新 ListView 的目的</span>
 Intent serviceIntent = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Intent(<span class="hljs-params">context</span>, ListWidgetService.<span class="hljs-params">class</span>)</span>;
 remoteViews.set<span class="hljs-constructor">RemoteAdapter(R.<span class="hljs-params">id</span>.<span class="hljs-params">lv_device</span>, <span class="hljs-params">serviceIntent</span>)</span>;</code></pre>

<h2 id="五-点击事件处理"><a href="#五-点击事件处理" class="headerlink" title="五.点击事件处理"></a>五.点击事件处理</h2><p>Widget中事件点击以及适配ListView，想必大家都有所了解了。那么对于事件的处理我们还没有提到，例如在Widget中点击了刷新后我们不能像在App中那样给控件设置一个事件监听来在回掉方法中处理。在文章开头我们就提到了Widget是依赖广播来实现，因此我们点击了刷新后其实仅仅是发送出来一个广播。如果我们不去处理广播那么点击事件其实是没有任何意义的。因此，来看ListWidgetProvider中第二个比较重要的方法onReceive()。这个方法比较简单，只要我们对特定的广播来做相应的处理就可以了。</p>
<pre><code class="hljs verilog">@Override
    public <span class="hljs-keyword">void</span> onReceive(Context <span class="hljs-keyword">context</span>, Intent intent) &#123;
        String action = intent<span class="hljs-variable">.getAction</span>();
        AppWidgetManager appWidgetManager = AppWidgetManager<span class="hljs-variable">.getInstance</span>(<span class="hljs-keyword">context</span>);
	        <span class="hljs-keyword">if</span> (action<span class="hljs-variable">.equals</span>(COLLECTION_VIEW_ACTION)) &#123;<span class="hljs-comment">//处理列表中的事件</span>
            <span class="hljs-comment">// 接受“ListView”的点击事件的广播</span>
            <span class="hljs-keyword">int</span> <span class="hljs-keyword">type</span> = intent<span class="hljs-variable">.getIntExtra</span>(<span class="hljs-string">&quot;Type&quot;</span>, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">int</span> appWidgetId = intent<span class="hljs-variable">.getIntExtra</span>(AppWidgetManager<span class="hljs-variable">.EXTRA_APPWIDGET_ID</span>,
                    AppWidgetManager<span class="hljs-variable">.INVALID_APPWIDGET_ID</span>);
            <span class="hljs-keyword">int</span> index = intent<span class="hljs-variable">.getIntExtra</span>(COLLECTION_VIEW_EXTRA, <span class="hljs-number">0</span>);
            switch (<span class="hljs-keyword">type</span>) &#123;
                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
                    Toast<span class="hljs-variable">.makeText</span>(<span class="hljs-keyword">context</span>, <span class="hljs-string">&quot;item&quot;</span> + index, Toast<span class="hljs-variable">.LENGTH_SHORT</span>)<span class="hljs-variable">.show</span>();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                    Toast<span class="hljs-variable">.makeText</span>(<span class="hljs-keyword">context</span>, <span class="hljs-string">&quot;lock&quot;</span>+index, Toast<span class="hljs-variable">.LENGTH_SHORT</span>)<span class="hljs-variable">.show</span>();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                    Toast<span class="hljs-variable">.makeText</span>(<span class="hljs-keyword">context</span>, <span class="hljs-string">&quot;unlock&quot;</span>+index, Toast<span class="hljs-variable">.LENGTH_SHORT</span>)<span class="hljs-variable">.show</span>();
                    <span class="hljs-keyword">break</span>;
            &#125;
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action<span class="hljs-variable">.equals</span>(REFRESH_WIDGET)) &#123;<span class="hljs-comment">//处理刷新事件</span>
            <span class="hljs-comment">// 接受“bt_refresh”的点击事件的广播</span>
            Toast<span class="hljs-variable">.makeText</span>(<span class="hljs-keyword">context</span>, <span class="hljs-string">&quot;刷新...&quot;</span>, Toast<span class="hljs-variable">.LENGTH_SHORT</span>)<span class="hljs-variable">.show</span>();
            <span class="hljs-keyword">final</span> AppWidgetManager mgr = AppWidgetManager<span class="hljs-variable">.getInstance</span>(<span class="hljs-keyword">context</span>);
            <span class="hljs-keyword">final</span> ComponentName cn = <span class="hljs-keyword">new</span> ComponentName(<span class="hljs-keyword">context</span>,ListWidgetProvider<span class="hljs-variable">.class</span>);
            ListRemoteViewsFactory<span class="hljs-variable">.refresh</span>();
            mgr<span class="hljs-variable">.notifyAppWidgetViewDataChanged</span>(mgr<span class="hljs-variable">.getAppWidgetIds</span>(cn),R<span class="hljs-variable">.id</span><span class="hljs-variable">.lv_device</span>);
            mHandler<span class="hljs-variable">.postDelayed</span>(runnable,<span class="hljs-number">2000</span>);
            showLoading(<span class="hljs-keyword">context</span>);
        &#125;
        <span class="hljs-keyword">super</span><span class="hljs-variable">.onReceive</span>(<span class="hljs-keyword">context</span>, intent);
    &#125;</code></pre>
<p>最后，别忘了ListWidgetProvider是广播，ListWidgetService是服务，都需要我们在AndroidManifest文件中来注册：</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">receiver</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.widget.ListWidgetProvider&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.appwidget.action.APPWIDGET_UPDATE&quot;</span> /&gt;</span>

            <span class="hljs-comment">&lt;!-- ListWidgetProvider接收点击ListView的响应事件 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.oitsme.COLLECTION_VIEW_ACTION&quot;</span> /&gt;</span>
            <span class="hljs-comment">&lt;!-- ListWidgetProvider接收点击bt_refresh的响应事件 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.oitsme.REFRESH_WIDGET&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.oitsme.LOCK_ACTION&quot;</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.oitsme.UNLOCK_ACTION&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.appwidget.provider&quot;</span></span>
<span class="hljs-tag">            <span class="hljs-attr">android:resource</span>=<span class="hljs-string">&quot;@xml/widget_provider&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">receiver</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">service</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.widget.ListWidgetService&quot;</span></span>
<span class="hljs-tag">        <span class="hljs-attr">android:permission</span>=<span class="hljs-string">&quot;android.permission.BIND_REMOTEVIEWS&quot;</span> /&gt;</span></code></pre>

<h2 id="六-小结"><a href="#六-小结" class="headerlink" title="六.小结"></a>六.小结</h2><p>至此关于列表小部件的讲解就完成了。只是自我感觉文章的逻辑有点乱。如果没明白，大家可以参考下面Demo源码。其实关于Widget的这个Demo其实早在几个月前就已经写好了，但由于最近项目紧再加上本身也是第一次接触Widget控件，因此直至近日才开始动笔写这篇文章。所以文章中避免不了有错误和不合理的地方，欢迎留言指正。</p>
<p>参考<br><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/appwidgets/">https://developer.android.com/guide/topics/appwidgets/</a></p>
<p><a target="_blank" rel="noopener" href="https://download.csdn.net/download/qq_20521573/11659588">源码下载</a></p>
<h3 id="好库推荐"><a href="#好库推荐" class="headerlink" title="好库推荐"></a>好库推荐</h3><p>给大家推荐一下<a target="_blank" rel="noopener" href="https://github.com/zhpanvip/BannerViewPager">BannerViewPager</a>。这是一个基于ViewPager实现的具有强大功能的无限轮播库。通过<a target="_blank" rel="noopener" href="https://github.com/zhpanvip/BannerViewPager">BannerViewPager</a>可以实现腾讯视频、QQ音乐、酷狗音乐、支付宝、天猫、淘宝、优酷视频、喜马拉雅、网易云音乐、哔哩哔哩等APP的Banner样式以及指示器样式。</p>
<p>欢迎大家到github关注<a target="_blank" rel="noopener" href="https://github.com/zhpanvip/BannerViewPager">BannerViewPager</a>！</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Widget/">Widget</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2018/07/14/14.%E8%87%AA%E5%AE%9A%E4%B9%89View%E4%B9%8B%E5%BC%B9%E6%80%A7%E6%BB%91%E5%8A%A8%E7%9A%84LockView/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">自定义View之弹性滑动的LockView</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/02/12/12.%E5%85%B3%E4%BA%8EHttps%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/">
                        <span class="hidden-mobile">关于Https的那些事儿</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    function loadValine() {
      addScript('https://cdn.staticfile.org/valine/1.4.14/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "hXIROaIM5y9qnieojJRWP5hS-gzGzoHsz",
          app_key: "y0f3w3aqd1MF7JL9ma4WECTy",
          placeholder: "说点什么",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: false,
          recordIP: false,
          serverURLs: "https://zhpanvip.github.io",
        });
      });
    }
    waitElementVisible('vcomments', loadValine);
  </script>
  <noscript>Please enable JavaScript to view the <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments
      powered by Valine.</a></noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Android Widget开发详解&nbsp;",
      ],
      cursorChar: "|",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















</body>
</html>
