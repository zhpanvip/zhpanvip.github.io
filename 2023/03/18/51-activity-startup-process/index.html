

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="zhangpan">
  <meta name="keywords" content="">
  <title>基于 Android 13 的 Activity 启动流程分析 - zhangpan&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="//at.alicdn.com/t/font_2048617_el7rbx5279a.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":50,"cursorChar":"|","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":200}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.1.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>我赌一包辣条</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://raw.githubusercontent.com/zhpanvip/images/master/blog/article.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="基于 Android 13 的 Activity 启动流程分析">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-03-18 21:43" pubdate>
        2023年3月18日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      8.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      59
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">基于 Android 13 的 Activity 启动流程分析</h1>
            
            <div class="markdown-body">
              <p>对于 Android 客户端开发者来说，Activity 是我们再熟悉不过的一个组件了。它是 Android 四大组件之一，是一个用于直接与用户交互的展示型 UI 组件。在开发过程中，启动并创建一个 Activity 流程非常简单，而在系统底层实际上做了大量的工作，之所以使用这么简单，得益于系统底层对于 Activity 的良好封装。本篇内容我们着重来分析一下 Framework 层 Activity 的启动与创建的过程。</p>
<h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>在 《<a target="_blank" rel="noopener" href="https://juejin.cn/post/6994057245113729038">不得不说的 Android Binder 机制与 AIDL</a>》这篇文章中我们了解了通过如何通过 Binder 与 AIDL 进行跨进程通信，在另一篇文章 《<a target="_blank" rel="noopener" href="https://juejin.cn/post/7110625878320775204">反思 Android 消息机制的设计与实现</a>》深入探讨了 Handler 消息机制的实现原理。这两篇文章，尤其是通过 Binder 与 AIDL 跨进程通信这块内容是理解本篇文章的基础，如果现在还不了解的同学建议先去阅读这两篇文章。</p>
<p>在平时的开发中，启动一个新的 Activity 只需要在当前 Activity 中调用<code>startActivity</code>方法，并传入一个Intent 即可，例如，从 MainActivity 启动一个 TestActivity 代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java">Intent intent = <span class="hljs-keyword">new</span> Intent(<span class="hljs-keyword">this</span>, TestActivity.class);<br>        startActivity(intent);<br></code></pre></td></tr></table></figure>
<p>两行看似简单的代码，实际上经历了与 system_service 进程的数次互相调用，才成功启动了一个 Activity。为方便理解，后文中我们把启动 Activity 的进程称为客户端，把 system_server 进程称为服务端。</p>
<h2 id="二、客户端的调用流程"><a href="#二、客户端的调用流程" class="headerlink" title="二、客户端的调用流程"></a>二、客户端的调用流程</h2><p>startActivity 的操作是由客户端发起的，因此当前的代码执行在客户端进程中。追进<code>startActivity</code>即可看到如下源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/Activity.java</span><br><br>    ActivityThread mMainThread;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startActivity</span><span class="hljs-params">(Intent intent)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.startActivity(intent, <span class="hljs-keyword">null</span>);<br>        &#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startActivity</span><span class="hljs-params">(Intent intent, <span class="hljs-meta">@Nullable</span> Bundle options)</span> </span>&#123;<br>        getAutofillClientController().onStartActivity(intent, mIntent);<br>        <span class="hljs-keyword">if</span> (options != <span class="hljs-keyword">null</span>) &#123;<br>        startActivityForResult(intent, -<span class="hljs-number">1</span>, options);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Note we want to go through this call for compatibility with</span><br>        <span class="hljs-comment">// applications that may have overridden the method.</span><br>        startActivityForResult(intent, -<span class="hljs-number">1</span>);<br>        &#125;<br>        &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startActivityForResult</span><span class="hljs-params">(<span class="hljs-meta">@RequiresPermission</span> Intent intent, <span class="hljs-keyword">int</span> requestCode,</span></span><br><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Nullable</span> Bundle options)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (mParent == <span class="hljs-keyword">null</span>) &#123;<br>        options = transferSpringboardActivityOptions(options);<br>        Instrumentation.ActivityResult ar =<br>        mInstrumentation.execStartActivity(<br>        <span class="hljs-keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="hljs-keyword">this</span>,<br>        intent, requestCode, options);<br>        <span class="hljs-keyword">if</span> (ar != <span class="hljs-keyword">null</span>) &#123;<br>        mMainThread.sendActivityResult(<br>        mToken, mEmbeddedID, requestCode, ar.getResultCode(),<br>        ar.getResultData());<br>        &#125;<br>        <span class="hljs-comment">// ...</span><br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// ...</span><br>        &#125;<br>        &#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，<code>startActivity</code> 方法最终会调用 <code>startActivityForResult</code> 方法，这个方法的核心代码是通过 <code>Instrumentation</code> 调用了 <code>execStartActivity</code>。而 <code>execStartActivity</code> 方法中的第二个参数为 <code>mMainThread.getApplicationThread()</code>，这里的 mMainThread 即为 ActivityThread，通过 ActivityThread 获取到了 ApplicationThread，ApplicationThread 是一个 Binder 类，这个类最终会被传到服务端，在服务端作为客户端的代理来调用客户端的代码，关于这个类后文还会分析。</p>
<p>继续跟进 Instrumentation 的 execStartActivity 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/Instrumentation.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> ActivityResult <span class="hljs-title">execStartActivity</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">        Context who, IBinder contextThread, IBinder token, Activity target,</span></span><br><span class="hljs-function"><span class="hljs-params">        Intent intent, <span class="hljs-keyword">int</span> requestCode, Bundle options)</span> </span>&#123;<br>        IApplicationThread whoThread = (IApplicationThread) contextThread;<br>        Uri referrer = target != <span class="hljs-keyword">null</span> ? target.onProvideReferrer() : <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">if</span> (referrer != <span class="hljs-keyword">null</span>) &#123;<br>        intent.putExtra(Intent.EXTRA_REFERRER, referrer);<br>        &#125;<br><br>        <span class="hljs-comment">// ...</span><br><br>        <span class="hljs-keyword">try</span> &#123;<br>        intent.migrateExtraStreamToClipData(who);<br>        intent.prepareToLeaveProcess(who);<br>        <span class="hljs-comment">// 通过 ActivityTaskManager 获取 Service 来启动 Activity</span><br>        <span class="hljs-keyword">int</span> result = ActivityTaskManager.getService().startActivity(whoThread,<br>        who.getOpPackageName(), who.getAttributionTag(), intent,<br>        intent.resolveTypeIfNeeded(who.getContentResolver()), token,<br>        target != <span class="hljs-keyword">null</span> ? target.mEmbeddedID : <span class="hljs-keyword">null</span>, requestCode, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, options);<br>        notifyStartActivityResult(result, options);<br>        <span class="hljs-comment">// 检查 Activity 的启动结果，例如是否在 AndroidManifest 文件中注册，没有则抛出异常</span><br>        checkStartActivityResult(result, intent);<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;Failure from system&quot;</span>, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br></code></pre></td></tr></table></figure>
<p>上述方法的核心代码是通过 ActivityTaskManager 获取到了一个 Service，具体是一个什么 Service 这里并不能看出来，我们继续跟进 ActivityTaskManager 的 getService 可以看到如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/ActivityTaskManager.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IActivityTaskManager <span class="hljs-title">getService</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> IActivityTaskManagerSingleton.get();<br>        &#125;<br><br><span class="hljs-meta">@UnsupportedAppUsage(trackingBug = 129726065)</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Singleton&lt;IActivityTaskManager&gt; IActivityTaskManagerSingleton =<br>        <span class="hljs-keyword">new</span> Singleton&lt;IActivityTaskManager&gt;() &#123;<br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> IActivityTaskManager <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">final</span> IBinder b = ServiceManager.getService(Context.ACTIVITY_TASK_SERVICE);<br>        <span class="hljs-keyword">return</span> IActivityTaskManager.Stub.asInterface(b);<br>        &#125;<br>        &#125;;<br></code></pre></td></tr></table></figure>
<p>这里可以看到 getService 获取到的是一个 IActivityTaskManager，IActivityTaskManager 是什么呢？通过搜索源码，发现它其实是一个 AIDL 类，目录为： <code>frameworks/base/core/java/android/app/IActivityTaskManager.aidl</code>，因此，IActivityTaskManager#startActivity 在这里肯定是一个跨进程的操作，到这里代码就进入了服务端进程，即 system_server 进程。</p>
<h2 id="三、服务端的调用流程"><a href="#三、服务端的调用流程" class="headerlink" title="三、服务端的调用流程"></a>三、服务端的调用流程</h2><p>经过上一小节的分析，代码已经执行到了 system_server 进程，那在 system_server 进程中调用的是哪个类呢？熟悉 AIDL 的同学应该清楚，在编译完代码后 <code>IActivityTaskManager</code> 这个 AIDL 文件会生成一个 IActivityTaskManager.Stub 类，这个类继承自 Binder, 并且会有一个名为 <code>startActivity</code> 的抽象方法。因此接下来我们需要找到哪个类继承了 IActivityTaskManager.Stub 即可，通过全局搜索我们发现 ActivityTaskManagerService 继承了 IActivityTaskManager.Stub，其部分源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ActivityTaskManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IActivityTaskManager</span>.<span class="hljs-title">Stub</span> </span>&#123;<br>    <span class="hljs-comment">// ...</span><br><br>    <span class="hljs-keyword">private</span> ActivityStartController mActivityStartController;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">startActivity</span><span class="hljs-params">(IApplicationThread caller, String callingPackage,</span></span><br><span class="hljs-function"><span class="hljs-params">            String callingFeatureId, Intent intent, String resolvedType, IBinder resultTo,</span></span><br><span class="hljs-function"><span class="hljs-params">            String resultWho, <span class="hljs-keyword">int</span> requestCode, <span class="hljs-keyword">int</span> startFlags, ProfilerInfo profilerInfo,</span></span><br><span class="hljs-function"><span class="hljs-params">            Bundle bOptions)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType,<br>                resultTo, resultWho, requestCode, startFlags, profilerInfo, bOptions,<br>                UserHandle.getCallingUserId());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">startActivityAsUser</span><span class="hljs-params">(IApplicationThread caller, String callingPackage,</span></span><br><span class="hljs-function"><span class="hljs-params">            String callingFeatureId, Intent intent, String resolvedType, IBinder resultTo,</span></span><br><span class="hljs-function"><span class="hljs-params">            String resultWho, <span class="hljs-keyword">int</span> requestCode, <span class="hljs-keyword">int</span> startFlags, ProfilerInfo profilerInfo,</span></span><br><span class="hljs-function"><span class="hljs-params">            Bundle bOptions, <span class="hljs-keyword">int</span> userId)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType,<br>                resultTo, resultWho, requestCode, startFlags, profilerInfo, bOptions, userId,<br>                <span class="hljs-keyword">true</span> <span class="hljs-comment">/*validateIncomingUser*/</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">startActivityAsUser</span><span class="hljs-params">(IApplicationThread caller, String callingPackage,</span></span><br><span class="hljs-function"><span class="hljs-params">            <span class="hljs-meta">@Nullable</span> String callingFeatureId, Intent intent, String resolvedType,</span></span><br><span class="hljs-function"><span class="hljs-params">            IBinder resultTo, String resultWho, <span class="hljs-keyword">int</span> requestCode, <span class="hljs-keyword">int</span> startFlags,</span></span><br><span class="hljs-function"><span class="hljs-params">            ProfilerInfo profilerInfo, Bundle bOptions, <span class="hljs-keyword">int</span> userId, <span class="hljs-keyword">boolean</span> validateIncomingUser)</span> </span>&#123;<br><br>        <span class="hljs-comment">// ... 省略配置项获取与校验</span><br><br><br>        userId = getActivityStartController().checkTargetUser(userId, validateIncomingUser,<br>                Binder.getCallingPid(), Binder.getCallingUid(), <span class="hljs-string">&quot;startActivityAsUser&quot;</span>);<br><br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Switch to user app stacks here.</span><br>        <span class="hljs-keyword">return</span> getActivityStartController().obtainStarter(intent, <span class="hljs-string">&quot;startActivityAsUser&quot;</span>)<br>                .setCaller(caller)<br>                .setCallingPackage(callingPackage)<br>                .setCallingFeatureId(callingFeatureId)<br>                .setResolvedType(resolvedType)<br>                .setResultTo(resultTo)<br>                .setResultWho(resultWho)<br>                .setRequestCode(requestCode)<br>                .setStartFlags(startFlags)<br>                .setProfilerInfo(profilerInfo)<br>                .setActivityOptions(opts)<br>                .setUserId(userId)<br>                .execute();<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>可以看到，在这个类中 <code>startActivity</code> 最终调用了 <code>startActivityAsUser</code> 方法，这个方法中的代码也比较简单，就是通过 <code>getActivityStartController().obtainStarter</code> 来配置相关参数，并最终执行 <code>execute</code>。</p>
<p><code>getActivityStartController()</code> 获取到的是一个 ActivityStartController 对象，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-function">ActivityStartController <span class="hljs-title">getActivityStartController</span><span class="hljs-params">()</span> </span>&#123;<br>   <span class="hljs-keyword">return</span> mActivityStartController;<br>   &#125;<br></code></pre></td></tr></table></figure>
<p>接着调用了 ActivityStartController 的 obtainStarter，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/// ActivityStartController</span><br><span class="hljs-function">ActivityStarter <span class="hljs-title">obtainStarter</span><span class="hljs-params">(Intent intent, String reason)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> mFactory.obtain().setIntent(intent).setReason(reason);<br>        &#125;<br></code></pre></td></tr></table></figure>
<p>obtainStarter 返回的是一个 ActivityStarter 对象，忽略相关参数的配置，我们直接看 ActivityStarter 的 execute 方法，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ActivityTaskSupervisor mSupervisor;<br><br>        <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>        onExecutionStarted();<br><br>        <span class="hljs-comment">// ... </span><br><br>        <span class="hljs-keyword">int</span> res;<br><span class="hljs-keyword">synchronized</span> (mService.mGlobalLock) &#123;<br>        <span class="hljs-comment">// ...</span><br><br>        res = executeRequest(mRequest);<br><br>        <span class="hljs-comment">// ...</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> getExternalResult(res);<br>        &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>        onExecutionComplete();<br>        &#125;<br>        &#125;<br></code></pre></td></tr></table></figure>
<p><code>execute</code> 方法又调用了 <code>executeRequest</code> 方法，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">executeRequest</span><span class="hljs-params">(Request request)</span> </span>&#123;<br><br><span class="hljs-comment">// ... 省略参数初始化及权限校验</span><br><br><span class="hljs-keyword">final</span> ActivityRecord r = <span class="hljs-keyword">new</span> ActivityRecord.Builder(mService)<br>        .setCaller(callerApp)<br>        .setLaunchedFromPid(callingPid)<br>        .setLaunchedFromUid(callingUid)<br>        .setLaunchedFromPackage(callingPackage)<br>        .setLaunchedFromFeature(callingFeatureId)<br>        .setIntent(intent)<br>        .setResolvedType(resolvedType)<br>        .setActivityInfo(aInfo)<br>        .setConfiguration(mService.getGlobalConfiguration())<br>        .setResultTo(resultRecord)<br>        .setResultWho(resultWho)<br>        .setRequestCode(requestCode)<br>        .setComponentSpecified(request.componentSpecified)<br>        .setRootVoiceInteraction(voiceSession != <span class="hljs-keyword">null</span>)<br>        .setActivityOptions(checkedOptions)<br>        .setSourceRecord(sourceRecord)<br>        .build();<br><br>        <span class="hljs-comment">// ...</span><br><br>        mLastStartActivityResult = startActivityUnchecked(r, sourceRecord, voiceSession,<br>        request.voiceInteractor, startFlags, <span class="hljs-keyword">true</span> <span class="hljs-comment">/* doResume */</span>, checkedOptions,<br>        inTask, inTaskFragment, restrictedBgActivity, intentGrants);<br><br>        <span class="hljs-keyword">if</span> (request.outActivity != <span class="hljs-keyword">null</span>) &#123;<br>        request.outActivity[<span class="hljs-number">0</span>] = mLastStartActivityRecord;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> mLastStartActivityResult;<br>        &#125;<br></code></pre></td></tr></table></figure>
<p>executeRequest 方法中的核心是实例化了 ActivityRecord，并调用 startActivityUnchecked，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">startActivityUnchecked</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span><br><span class="hljs-function"><span class="hljs-params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span><br><span class="hljs-function"><span class="hljs-params">        <span class="hljs-keyword">int</span> startFlags, <span class="hljs-keyword">boolean</span> doResume, ActivityOptions options, Task inTask,</span></span><br><span class="hljs-function"><span class="hljs-params">        TaskFragment inTaskFragment, <span class="hljs-keyword">boolean</span> restrictedBgActivity,</span></span><br><span class="hljs-function"><span class="hljs-params">        NeededUriGrants intentGrants)</span> </span>&#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>        mService.deferWindowLayout();<br>        <span class="hljs-keyword">try</span> &#123;<br>        result = startActivityInner(r, sourceRecord, voiceSession, voiceInteractor,<br>        startFlags, doResume, options, inTask, inTaskFragment, restrictedBgActivity,<br>        intentGrants);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-comment">// ...</span><br>        &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>        mService.continueWindowLayout();<br>        &#125;<br>        postStartActivityProcessing(r, result, startedActivityRootTask);<br><br>        <span class="hljs-keyword">return</span> result;<br>        &#125;`java<br><br></code></pre></td></tr></table></figure>
<p><code>startActivityUnchecked</code> 方法中又调用了 <code>startActivityInner</code>，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityStarter.java</span><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RootWindowContainer mRootWindowContainer;<br><br>        <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">startActivityInner</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span><br><span class="hljs-function"><span class="hljs-params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span><br><span class="hljs-function"><span class="hljs-params">        <span class="hljs-keyword">int</span> startFlags, <span class="hljs-keyword">boolean</span> doResume, ActivityOptions options, Task inTask,</span></span><br><span class="hljs-function"><span class="hljs-params">        TaskFragment inTaskFragment, <span class="hljs-keyword">boolean</span> restrictedBgActivity,</span></span><br><span class="hljs-function"><span class="hljs-params">        NeededUriGrants intentGrants)</span> </span>&#123;<br>        setInitialState(r, options, inTask, inTaskFragment, doResume, startFlags, sourceRecord,<br>        voiceSession, voiceInteractor, restrictedBgActivity);<br><br>        <span class="hljs-comment">// 处理 Intent 中携带的 flags</span><br>        computeLaunchingTaskFlags();<br><br>        <span class="hljs-comment">// 获取启动 Activity 的任务栈，这里即获取 MainActivity 所在的任务栈 </span><br>        computeSourceRootTask();<br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// 查找可用的任务栈</span><br><span class="hljs-keyword">final</span> Task reusedTask = getReusableTask();<br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// 如果 reusedTask 不空，则使用 reusedTask 任务栈，否则寻找目标任务栈</span><br><span class="hljs-keyword">final</span> Task targetTask = reusedTask != <span class="hljs-keyword">null</span> ? reusedTask : computeTargetTask();<br><span class="hljs-comment">// 目标任务栈为空，则标记为使用新任务栈，需要新建任务栈</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> newTask = targetTask == <span class="hljs-keyword">null</span>;<br><br>        mTargetTask = targetTask;<br><br>        computeLaunchParams(r, sourceRecord, targetTask);<br><br><br>        <span class="hljs-keyword">if</span> (newTask) &#123;<br><span class="hljs-comment">// 创建一个新的任务栈</span><br><span class="hljs-keyword">final</span> Task taskToAffiliate = (mLaunchTaskBehind &amp;&amp; mSourceRecord != <span class="hljs-keyword">null</span>)<br>        ? mSourceRecord.getTask() : <span class="hljs-keyword">null</span>;<br>        <span class="hljs-comment">// 将 Activity 放入新建的任务栈        </span><br>        setNewTask(taskToAffiliate);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mAddingToTask) &#123;<br>        <span class="hljs-comment">// 加入已有的任务栈</span><br>        addOrReparentStartingActivity(targetTask, <span class="hljs-string">&quot;adding to task&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// ...</span><br><br>        <span class="hljs-keyword">if</span> (mDoResume) &#123;<br>        <span class="hljs-comment">// ...</span><br>        mRootWindowContainer.resumeFocusedTasksTopActivities(<br>        mTargetRootTask, mStartActivity, mOptions, mTransientLaunch);<br>        &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> START_SUCCESS;<br>        &#125;<br><br></code></pre></td></tr></table></figure>
<p>startActivityInner 方法中的代码比较复杂。经过了简化处理后，可以看到这个方法里主要是处理任务栈相关的逻辑，如果找到可用的任务栈则直接使用这个任务栈，如果没有找到，则新建一个任务栈。 在完成任务栈的处理之后通过<code>mRootWindowContainer.resumeFocusedTasksTopActivities</code>继续 Activity 的启动流程，这里的 mRootWindowContainer 是 RootWindowContainer 的实例，resumeFocusedTasksTopActivities 代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/wm/RootWindowContainer.java</span><br><br> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">resumeFocusedTasksTopActivities</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">            Task targetRootTask, ActivityRecord target, ActivityOptions targetOptions,</span></span><br><span class="hljs-function"><span class="hljs-params">            <span class="hljs-keyword">boolean</span> deferPause)</span> </span>&#123;<br>        <span class="hljs-comment">// ...</span><br>        <br>        <span class="hljs-keyword">boolean</span> result = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-keyword">if</span> (targetRootTask != <span class="hljs-keyword">null</span> &amp;&amp; (targetRootTask.isTopRootTaskInDisplayArea()<br>                || getTopDisplayFocusedRootTask() == targetRootTask)) &#123;<br>            result = targetRootTask.resumeTopActivityUncheckedLocked(target, targetOptions,deferPause);<br>        &#125;<br>        <br>        <span class="hljs-comment">// ...</span><br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>这个方法中将启动相关的代码交给了 Task 的 <code>resumeTopActivityUncheckedLocked</code> 方法。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java">frameworks/base/services/core/java/com/android/server/wm/Task.java<br><br><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">resumeTopActivityUncheckedLocked</span><span class="hljs-params">(ActivityRecord prev, ActivityOptions options,</span></span><br><span class="hljs-function"><span class="hljs-params">            <span class="hljs-keyword">boolean</span> deferPause)</span> </span>&#123;<br>        <span class="hljs-comment">// ...</span><br><br>        <span class="hljs-keyword">boolean</span> someActivityResumed = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// Protect against recursion.</span><br>            mInResumeTopActivity = <span class="hljs-keyword">true</span>;<br><br>            <span class="hljs-keyword">if</span> (isLeafTask()) &#123;<br>                <span class="hljs-keyword">if</span> (isFocusableAndVisible()) &#123;<br>                    someActivityResumed = resumeTopActivityInnerLocked(prev, options, deferPause);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                       <span class="hljs-comment">// ...</span><br>                   &#125;<br>            &#125;<br><br>        <span class="hljs-comment">// ...</span><br><br>        <span class="hljs-keyword">return</span> someActivityResumed;<br>    &#125;<br>    <br>    <br><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">resumeTopActivityUncheckedLocked</span><span class="hljs-params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> resumeTopActivityUncheckedLocked(prev, options, <span class="hljs-keyword">false</span> <span class="hljs-comment">/* skipPause */</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@GuardedBy(&quot;mService&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">resumeTopActivityInnerLocked</span><span class="hljs-params">(ActivityRecord prev, ActivityOptions options,</span></span><br><span class="hljs-function"><span class="hljs-params">            <span class="hljs-keyword">boolean</span> deferPause)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!mAtmService.isBooting() &amp;&amp; !mAtmService.isBooted()) &#123;<br>            <span class="hljs-comment">// Not ready yet!</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <span class="hljs-comment">// 任务栈栈顶正在运行的 Activity </span><br>        <span class="hljs-keyword">final</span> ActivityRecord topActivity = topRunningActivity(<span class="hljs-keyword">true</span> <span class="hljs-comment">/* focusableOnly */</span>);<br>        <span class="hljs-keyword">if</span> (topActivity == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-comment">// 空任务栈 There are no activities left in this task, let&#x27;s look somewhere else.</span><br>            <span class="hljs-keyword">return</span> resumeNextFocusableActivityWhenRootTaskIsEmpty(prev, options);<br>        &#125;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span>[] resumed = <span class="hljs-keyword">new</span> <span class="hljs-keyword">boolean</span>[<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">final</span> TaskFragment topFragment = topActivity.getTaskFragment();<br>        resumed[<span class="hljs-number">0</span>] = topFragment.resumeTopActivity(prev, options, deferPause);<br>        <span class="hljs-comment">// ...</span><br>        <span class="hljs-keyword">return</span> resumed[<span class="hljs-number">0</span>];<br>    &#125;<br>    <br></code></pre></td></tr></table></figure>
<p>在 Task 的 resumeTopActivityUncheckedLocked 方法中进而又调用了resumeTopActivityUncheckedLocked，在 resumeTopActivityInnerLocked 中通过 TaskFragment 调用了 resumeTopActivity，接着来看 TaskFragment 中的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java">frameworks/base/services/core/java/com/android/server/wm/TaskFragment.java<br><br><span class="hljs-keyword">final</span> ActivityTaskSupervisor mTaskSupervisor;<br><br><span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">resumeTopActivity</span><span class="hljs-params">(ActivityRecord prev, ActivityOptions options,</span></span><br><span class="hljs-function"><span class="hljs-params">            <span class="hljs-keyword">boolean</span> deferPause)</span> </span>&#123;<br>        ActivityRecord next = topRunningActivity(<span class="hljs-keyword">true</span> <span class="hljs-comment">/* focusableOnly */</span>);<br>         <span class="hljs-comment">// ...</span><br>         <br>         <span class="hljs-keyword">if</span> (mResumedActivity != <span class="hljs-keyword">null</span>) &#123;<br>             <span class="hljs-comment">// 暂停栈顶的Activity</span><br>            pausing |= startPausing(mTaskSupervisor.mUserLeaving, <span class="hljs-keyword">false</span> <span class="hljs-comment">/* uiSleeping */</span>, next, <span class="hljs-string">&quot;resumeTopActivity&quot;</span>);<br>        &#125;<br>         <br>        <span class="hljs-comment">// ... </span><br>           <br>        <span class="hljs-comment">// 要启动的 Activity 已存在，且不需要重新创建，例如设置了 singleTask 或 singleTop启动模式</span><br>        <span class="hljs-keyword">if</span> (next.attachedToProcess()) &#123;<br>            <span class="hljs-comment">// ...</span><br><br>            ActivityRecord lastResumedActivity =<br>                    lastFocusedRootTask == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span><br>                            : lastFocusedRootTask.getTopResumedActivity();<br>            <span class="hljs-keyword">final</span> ActivityRecord.State lastState = next.getState();<br><br>            mAtmService.updateCpuStats();<br><br>            next.setState(RESUMED, <span class="hljs-string">&quot;resumeTopActivity&quot;</span>);<br><br>            <span class="hljs-comment">// Have the window manager re-evaluate the orientation of</span><br>            <span class="hljs-comment">// the screen based on the new activity order.</span><br>            <span class="hljs-keyword">boolean</span> notUpdated = <span class="hljs-keyword">true</span>;<br><br>            <span class="hljs-comment">// ...</span><br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 开启一个事务</span><br>                <span class="hljs-keyword">final</span> ClientTransaction transaction =<br>                        ClientTransaction.obtain(next.app.getThread(), next.token);<br>                 <span class="hljs-comment">// ...</span><br><br>                <span class="hljs-keyword">if</span> (next.newIntents != <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-comment">// 添加 onNewIntent 的 callback ，最终会在APP端执行 onNewIntent()</span><br>                    transaction.addCallback(<br>                            NewIntentItem.obtain(next.newIntents, <span class="hljs-keyword">true</span> <span class="hljs-comment">/* resume */</span>));<br>                &#125;<br><br>                <span class="hljs-comment">// ...</span><br>               <br>                <span class="hljs-comment">// 设置 Activity 最终的生命周期状态为 Resume</span><br>                transaction.setLifecycleStateRequest(<br>                        ResumeActivityItem.obtain(next.app.getReportedProcState(),<br>                                dc.isNextTransitionForward()));<br>                <span class="hljs-comment">// Flag1：开始执行事务                </span><br>                mAtmService.getLifecycleManager().scheduleTransaction(transaction);<br><br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-comment">// ...</span><br>                <br>                <span class="hljs-comment">// Resume 异常，重新启动</span><br>                mTaskSupervisor.startSpecificActivity(next, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br><br>           <span class="hljs-comment">// ...</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// ...</span><br>            <br>            <span class="hljs-comment">// 启动 Activity</span><br>            mTaskSupervisor.startSpecificActivity(next, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>resumeTopActivity 方法中主要有两部分内容。</p>
<ul>
<li>next.attachedToProcess() 为 true，即要启动的这个 Activity 已经存在，并且设置了像“singleInstance” 的启动模式，无需重新创建 Activity 的情况下，则先通过 ClientTransaction 添加了一个 NewIntentItem 的 callback，接下来通过 setLifecycleStateRequest 设置了一个 ResumeActivityItem 对象。</li>
<li>next.attachedToProcess() 为 false ，则继续执行 Activity 的启动流程</li>
</ul>
<p>第一部分中的 ClientTransaction 是什么？ scheduleTransaction 又是做了什么？这里先不做探讨，留一个Flag，后边再来分析。</p>
<p>接着继续看主线流程，在 <code>next.attachedToProcess()</code> 返回 false 之后，通过 ActivityTaskSupervisor 调用了 <code>startSpecificActivity</code>，这里是 Activity 正常启动的流程，查看 <code>startSpecificActivity</code> 源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java">frameworks/base/services/core/java/com/android/server/wm/ActivityTaskSupervisor.java<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">startSpecificActivity</span><span class="hljs-params">(ActivityRecord r, <span class="hljs-keyword">boolean</span> andResume, <span class="hljs-keyword">boolean</span> checkConfig)</span> </span>&#123;<br>        <span class="hljs-comment">// Is this activity&#x27;s application already running?</span><br>        <span class="hljs-keyword">final</span> WindowProcessController wpc =<br>                mService.getProcessController(r.processName, r.info.applicationInfo.uid);<br><br>        <span class="hljs-keyword">boolean</span> knownToBeDead = <span class="hljs-keyword">false</span>;<br>        <br>        <span class="hljs-keyword">if</span> (wpc != <span class="hljs-keyword">null</span> &amp;&amp; wpc.hasThread()) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                realStartActivityLocked(r, wpc, andResume, checkConfig);<br>                <span class="hljs-keyword">return</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>               <span class="hljs-comment">// ...</span><br>            &#125;<br><br>            <span class="hljs-comment">// ...</span><br>        &#125;<br><br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>    <br>   <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">realStartActivityLocked</span><span class="hljs-params">(ActivityRecord r, WindowProcessController proc,</span></span><br><span class="hljs-function"><span class="hljs-params">            <span class="hljs-keyword">boolean</span> andResume, <span class="hljs-keyword">boolean</span> checkConfig)</span> <span class="hljs-keyword">throws</span> RemoteException </span>&#123;<br><br>        <span class="hljs-comment">// ...</span><br><br>        <span class="hljs-keyword">final</span> Task task = r.getTask();<br>        <span class="hljs-keyword">final</span> Task rootTask = task.getRootTask();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// ...</span><br><br>                <span class="hljs-comment">// 创建启动 Activity 的事务</span><br>                <span class="hljs-keyword">final</span> ClientTransaction clientTransaction = ClientTransaction.obtain(<br>                        proc.getThread(), r.token);<br><br>                <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> isTransitionForward = r.isTransitionForward();<br>                <span class="hljs-keyword">final</span> IBinder fragmentToken = r.getTaskFragment().getFragmentToken();<br>                <br>                <span class="hljs-comment">// 添加启动 Activity 的 callback，执行launchActivity</span><br>                clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="hljs-keyword">new</span> Intent(r.intent),<br>                        System.identityHashCode(r), r.info,<br>                        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Have this take the merged configuration instead of separate global</span><br>                        <span class="hljs-comment">// and override configs.</span><br>                        mergedConfiguration.getGlobalConfiguration(),<br>                        mergedConfiguration.getOverrideConfiguration(), r.compat,<br>                        r.getFilteredReferrer(r.launchedFromPackage), task.voiceInteractor,<br>                        proc.getReportedProcState(), r.getSavedState(), r.getPersistentSavedState(),<br>                        results, newIntents, r.takeOptions(), isTransitionForward,<br>                        proc.createProfilerInfoIfNeeded(), r.assistToken, activityClientController,<br>                        r.shareableActivityToken, r.getLaunchedFromBubble(), fragmentToken));<br><br>                <span class="hljs-comment">// Activity 启动后最终的生命周期状态</span><br>                <span class="hljs-keyword">final</span> ActivityLifecycleItem lifecycleItem;<br>                <span class="hljs-keyword">if</span> (andResume) &#123;<br>                    <span class="hljs-comment">// 将最终生命周期设置为 Resume 状态</span><br>                    lifecycleItem = ResumeActivityItem.obtain(isTransitionForward);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// 将最终生命周期设置为 Pause 状态</span><br>                    lifecycleItem = PauseActivityItem.obtain();<br>                &#125;<br>                <span class="hljs-comment">// 设置 Activity 启动后最终的生命周期状态</span><br>                clientTransaction.setLifecycleStateRequest(lifecycleItem);<br><br>                <span class="hljs-comment">// 开启事务</span><br>                mService.getLifecycleManager().scheduleTransaction(clientTransaction);<br><br>               <span class="hljs-comment">// ...</span><br><br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                <span class="hljs-comment">// ...</span><br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// ...</span><br>        &#125;<br><br>        <span class="hljs-comment">// ...</span><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br> <br></code></pre></td></tr></table></figure>
<p><code>startSpecificActivity</code> 方法中最核心的逻辑是调用了 <code>realStartActivityLocked</code> ，这个方法中同样是获取了一个 ClientTransaction 实例，并调用了它的 addCallback 方法，与上边不同的是，这里添加了一个 LaunchActivityItem 实例。</p>
<p>这里与上边 Flag 处的代码逻辑是一样，只是添加的 callback 不同，那 ClientTransaction 是什么？它与 Activity 的启动又有什么关系呢？</p>
<h4 id="1-ClientTransaction"><a href="#1-ClientTransaction" class="headerlink" title="1. ClientTransaction"></a>1. ClientTransaction</h4><p>ClientTransaction 是包含了一系列要执行的事务项的事务。我们可以通过调用它的 <code>addCallback</code>方法来添加一个事务项，你也可以多次调用来添加多个事务项。addCallback 接收的参数类型为 ClientTransactionItem，而这个 ClientTransactionItem 有多个子类，例如上边已经出现过的 NewIntentItem、LaunchActivityItem 等都是其子类。</p>
<p>另外可以通过 ClientTransactionItem 的 <code>setLifecycleStateRequest</code> 方法设置 Activity 执行完后最终的生命周期状态，其参数的类型为 ActivityLifecycleItem。ActivityLifecycleItem 也是继承自 ClientTransactionItem。同时，ActivityLifecycleItem 也有多个子类，它的每个子类都对应了 Activity 的一个生命周期事件。</p>
<p>在完成 callback 与 lifeCycleStateRequest 的设置之后，便通过调用 <code>mService.getLifecycleManager().scheduleTransaction(clientTransaction)</code>方法开启事务项的执行。</p>
<p>这里的 mService.getLifecycleManager() 获取到的是什么呢？跟踪 ActivityTaskManagerService 源码我们可以找到 getLifecycleManager 的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClientLifecycleManager mLifecycleManager;<br>    <br>    <span class="hljs-function">ClientLifecycleManager <span class="hljs-title">getLifecycleManager</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> mLifecycleManager;<br>    &#125;<br><br></code></pre></td></tr></table></figure>
<p>可以看到，getLifecycleManager 返回了一个 ClientLifecycleManager 的实例，并调用了 scheduleTransaction 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/wm/ClientLifecycleManager.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">scheduleTransaction</span><span class="hljs-params">(ClientTransaction transaction)</span> <span class="hljs-keyword">throws</span> RemoteException </span>&#123;<br>        <span class="hljs-keyword">final</span> IApplicationThread client = transaction.getClient();<br>        transaction.schedule();<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br><br></code></pre></td></tr></table></figure>
<p>上述方法的核心代码是调用了 ClientTransaction 的 schedule 方法，schedule 方法源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/servertransaction/ClientTransaction.java</span><br><br><span class="hljs-keyword">private</span> IApplicationThread mClient;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">schedule</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException </span>&#123;<br>        mClient.scheduleTransaction(<span class="hljs-keyword">this</span>);<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>在 schedule 方法中通过 mClient 调用了 scheduleTransaction，<br>这里的 mClient 即为 IApplicationThread，也就是我们在第二章中提到的客户端的 Binder。这个参数是在实例化 ClientTransaction 时传进来的，IApplicationThread 是一个AIDL 类，那么通过编译后它会生成一个 IApplicationThread.Stub 类，上文中提到的 <strong>ActivityThread#ApplicationThread</strong> 就是继承了IApplicationThread.Stub。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/ActivityThread#ApplicationThread </span><br><br><span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IApplicationThread</span>.<span class="hljs-title">Stub</span> </span>&#123;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>既然我们已经知道了 IApplicationThread 是客户端 Binder 在服务端的代理， 那么这里实际上是就是调用了客户端 ApplicationThread 中的 scheduleTransaction 方法。</p>
<p>至此，代码最终又回到了客户端的 ApplicationThread 中。但是，关于 ClientTransaction 的分析到这里还未结束。可以看到的是，此时的代码又通过 scheduleTransaction 方法回到了客户端，并且将 ClientTransaction 作为参数传了过去。那么，ClientTransaction 的执行逻辑实际上在客户端中执行的。</p>
<h2 id="四、再探客户端的调用流程"><a href="#四、再探客户端的调用流程" class="headerlink" title="四、再探客户端的调用流程"></a>四、再探客户端的调用流程</h2><p>通过 Binder IPC，代码的调用流程又回到了客户端，来看 ApplicationThread 中 scheduleTransaction 方法的实现，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/ActivityThread#ApplicationThread</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">scheduleTransaction</span><span class="hljs-params">(ClientTransaction transaction)</span> <span class="hljs-keyword">throws</span> RemoteException </span>&#123;<br>        ActivityThread.<span class="hljs-keyword">this</span>.scheduleTransaction(transaction);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>这个方法中又调用了 ActivityThread 的 scheduleTransaction 。而 scheduleTransaction 的源码在ActivityThread 的父类 ClientTransactionHandler 中， 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/ClientTransactionHandler.java</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">scheduleTransaction</span><span class="hljs-params">(ClientTransaction transaction)</span> </span>&#123;<br>        transaction.preExecute(<span class="hljs-keyword">this</span>);<br>        sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这里将 transaction 作为参数调用了 sendMessage 方法。sendMessage 方法源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-keyword">int</span> what, Object obj)</span> </span>&#123;<br>    sendMessage(what, obj, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">false</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-keyword">int</span> what, Object obj, <span class="hljs-keyword">int</span> arg1)</span> </span>&#123;<br>    sendMessage(what, obj, arg1, <span class="hljs-number">0</span>, <span class="hljs-keyword">false</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-keyword">int</span> what, Object obj, <span class="hljs-keyword">int</span> arg1, <span class="hljs-keyword">int</span> arg2)</span> </span>&#123;<br>    sendMessage(what, obj, arg1, arg2, <span class="hljs-keyword">false</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-keyword">int</span> what, Object obj, <span class="hljs-keyword">int</span> arg1, <span class="hljs-keyword">int</span> arg2, <span class="hljs-keyword">boolean</span> async)</span> </span>&#123;<br>    <br>    Message msg = Message.obtain();<br>    msg.what = what;<br>    msg.obj = obj;<br>    msg.arg1 = arg1;<br>    msg.arg2 = arg2;<br>    <span class="hljs-keyword">if</span> (async) &#123;<br>        <span class="hljs-comment">// 设置异步消息，会优先执行</span><br>        msg.setAsynchronous(<span class="hljs-keyword">true</span>);<br>    &#125;<br>    mH.sendMessage(msg);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以看到，这里最终将 ClientTransaction 与 EXECUTE_TRANSACTION 打包成一个 Message ,并且将这个 Message 设置成了异步消息，最终通过 mH 发送了出去，这里的 mH 是一个继承自 Handler 的 <code>H</code> 类，位于 ActivityThread 类的内部。</p>
<blockquote>
<p>Message 被设置为异步消息后具有优先执行权，因为 Activity 的启动涉及到 Activity 的创建以及生命周期的调用，所有这里发送出来的 Message 不应该被其他 Message 阻塞，不然肯定会影响到 Activity 的启动，造成卡顿问题。具体分析可以参见 《<a target="_blank" rel="noopener" href="https://juejin.cn/post/7110625878320775204">反思 Android 消息机制的设计与实现</a>》 这篇文章。</p>
</blockquote>
<p>接下来看一下在 H 类的内部是如何处理这条消息的，我们搜索 <code>EXECUTE_TRANSACTION</code> 可以看到如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/ActivityThread#H</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleMessage</span><span class="hljs-params">(Message msg)</span> </span>&#123;<br>    <span class="hljs-keyword">switch</span> (msg.what) &#123;<br>    <span class="hljs-keyword">case</span> EXECUTE_TRANSACTION:<br>            <span class="hljs-keyword">final</span> ClientTransaction transaction = (ClientTransaction) msg.obj;<br>            mTransactionExecutor.execute(transaction);<br>            <span class="hljs-comment">// ...</span><br>             <span class="hljs-keyword">break</span>;<br>    <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里的代码很简单，通过 Message 拿到 ClientTransaction 后，然后通过 TransactionExecutor 的 execute 方法来执行 ClientTransaction。</p>
<p>在上一章中，我们只是对 ClientTransaction 做了简单的介绍。虽然 ClientTransaction 的实例化是在服务端，但其执行流程却是在客户端。看一下 TransactionExecutor 中 execute 源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/servertransaction/TransactionExecutor.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(ClientTransaction transaction)</span> </span>&#123;<br><br>       <span class="hljs-comment">// ...</span><br>        <br>        <span class="hljs-comment">// 执行 callback</span><br>        executeCallbacks(transaction);<br>        <span class="hljs-comment">// 执行 lifecycleState</span><br>        executeLifecycleState(transaction);<br>        <br>        mPendingActions.clear();<br>       <br>    &#125;   <br></code></pre></td></tr></table></figure>
<p>这个方法里的执行逻辑可以分为两部分：</p>
<ul>
<li>通过 executeCallbacks 方法执行所有被添加进来的 ClientTransactionItem</li>
<li>通过 executeLifecycleState 方法将 Activity 的生命周期执行到指定的状态</li>
</ul>
<h3 id="1-executeCallbacks-方法分析"><a href="#1-executeCallbacks-方法分析" class="headerlink" title="1. executeCallbacks 方法分析"></a>1. executeCallbacks 方法分析</h3><p>executeCallbacks 方法中的逻辑比较简单，其源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeCallbacks</span><span class="hljs-params">(ClientTransaction transaction)</span> </span>&#123;<br>        <span class="hljs-comment">// ...</span><br>        <br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> size = callbacks.size();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; ++i) &#123;<br>            <span class="hljs-comment">// ...</span><br>            <span class="hljs-keyword">final</span> ClientTransactionItem item = callbacks.get(i);<br>            item.execute(mTransactionHandler, token, mPendingActions);<br>            <span class="hljs-comment">// ...</span><br>            <br>            cycleToPath(r, postExecutionState, shouldExcludeLastTransition, transaction);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>在 executeCallbacks 中遍历了所有的 ClientTransactionItem 并执行了 ClientTransactionItem 的 execute 方法。上一章我们分析了，当 Activity 正常启动时，通过 addCallback 添加的是一个 LaunchActivityItem 的实例。以此为例，这里就会首先执行 LaunchActivityItem 的 execute 方法，进而执行 Activity 的实例化及 onCreate 生命周期的调用。这块源码留作后边再来分析。</p>
<h3 id="2-ClientTransactionItem"><a href="#2-ClientTransactionItem" class="headerlink" title="2. ClientTransactionItem"></a>2. ClientTransactionItem</h3><p>我们上文提到过 ClientTransactionItem 有多个实现类，这些实现类对应了 Activity 中不同的执行流程。例如在 Activity 启动时如果不需要重新创建 Activity ，则会通过 addCallback 添加了一个 NewIntentItem 来执行 Activity 的 onNewIntennt 方法。而当需要重新创建 Activity 时，则传入的是一个 LaunchActivityItem，用来创建并启动Activity。</p>
<p>ClientTransactionItem 的所有子类或相关类均在 frameworks/base/core/java/android/app/servertransaction/ 目录下，如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/zhpanvip/images/master/project/article/framework/5101.webp" srcset="/img/loading.gif" alt="image.png"></p>
<p>上文中提到的 ActivityLifecycleItem 继承自 ClientTransactionItem ，且其子类均为 Activity 生命周相关的实现，例如，StartActivityItem、ResumeActivityItem、DestroyActivityItem 等。显而易见的是，这里将 Activity 的生命周期以及其它相关方法以面向对象的思想封装成了一个个的对象来执行。相比早些年的 Android 版本代码，所有生命周期以及相关方法都通过 Handler 的 sendMessage 的方式发送出来，这种面向对象的思想的逻辑更加清晰，且代码更容易维护。</p>
<h3 id="3-executeLifecycleState-方法分析"><a href="#3-executeLifecycleState-方法分析" class="headerlink" title="3. executeLifecycleState 方法分析"></a>3. executeLifecycleState 方法分析</h3><p>接着来看 executeCallbacks 中的 executeLifecycleState 方法，前面提到过，这里会将 Activity 执行到指定的生命周期状态。上边的代码中我们看到在 Activity 启动时，setLifecycleStateRequest 设置的是一个 ResumeActivityItem，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 设置 Activity 最终的生命周期状态为 Resume</span><br>transaction.setLifecycleStateRequest(<br>       ResumeActivityItem.obtain(next.app.getReportedProcState(),<br>              dc.isNextTransitionForward()));<br></code></pre></td></tr></table></figure>

<p>设置了 ResumeActivityItem后，接下来的代码会怎么执行呢？来看 <code>executeLifecycleState</code> 方法的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeLifecycleState</span><span class="hljs-params">(ClientTransaction transaction)</span> </span>&#123;<br>     <span class="hljs-keyword">final</span> ActivityLifecycleItem lifecycleItem = transaction.getLifecycleStateRequest();<br>     <span class="hljs-comment">// ...</span><br><br>     <span class="hljs-comment">// 第二个参数为执行完时的生命周状态</span><br>     cycleToPath(r, lifecycleItem.getTargetState(), <span class="hljs-keyword">true</span> <span class="hljs-comment">/* excludeLastState */</span>, transaction);<br><br>     <span class="hljs-comment">// Execute the final transition with proper parameters.</span><br>     lifecycleItem.execute(mTransactionHandler, token, mPendingActions);<br>     <br>     lifecycleItem.postExecute(mTransactionHandler, token, mPendingActions);<br> &#125;<br></code></pre></td></tr></table></figure>
<p>这段代码的关键点在于 <code>cycleToPath</code> 。同时，通过 lifecycleItem.getTargetState() 作为结束时的生命周期状态。由于此时设置的是一个 ResumeActivityItem，它的 getTargetState 返回的是一个 ON_RESUME 的值，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// frameworks/base/core/java/android/app/servertransaction/ResumeActivityItem.java</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getTargetState</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> ON_RESUME;<br>    &#125;<br>    <br>    <br>    <span class="hljs-meta">@Retention(RetentionPolicy.SOURCE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> LifecycleState&#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> UNDEFINED = -<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> PRE_ON_CREATE = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ON_CREATE = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ON_START = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ON_RESUME = <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ON_PAUSE = <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ON_STOP = <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ON_DESTROY = <span class="hljs-number">6</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ON_RESTART = <span class="hljs-number">7</span>;<br><br></code></pre></td></tr></table></figure>

<p>可以看到 ON_RESUME 的值为 3。接着来看 cycleToPath 源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cycleToPath</span><span class="hljs-params">(ActivityClientRecord r, <span class="hljs-keyword">int</span> finish, <span class="hljs-keyword">boolean</span> excludeLastState,</span></span><br><span class="hljs-function"><span class="hljs-params">            ClientTransaction transaction)</span> </span>&#123;<br>        <span class="hljs-comment">// 获取当前 Activity 的生命周期状态，即开始时的状态    </span><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> start = r.getLifecycleState();<br>        <span class="hljs-comment">// 获取要执行的生命周期数组</span><br>        <span class="hljs-keyword">final</span> IntArray path = mHelper.getLifecyclePath(start, finish, excludeLastState);<br>        <span class="hljs-comment">// 按顺序执行 Activity 的生命周期</span><br>        performLifecycleSequence(r, path, transaction);<br>    &#125;<br><br></code></pre></td></tr></table></figure>
<p>在这个方法中，首先获取了当前 Activity 生命周期状态，即开始执行 getLifecyclePath 时 Activity 的生命周期状态，由于 executeLifecycleState 方法是在 executeCallback 之后执行的，上面我们已经提到此时的 Activity 已经执行完了创建流程，并执行过了 onCreate 的生命周期。因此，这里的 start 应该是 ON_CREATE 状态，ON_CREATE 的值为 1。</p>
<p>那么接下来，这里的关键点就在于 getLifecyclePath 做了什么。我们看一下源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// frameworks/base/core/java/android/app/servertransaction/TransactionExecutorHelper.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> IntArray <span class="hljs-title">getLifecyclePath</span><span class="hljs-params">(<span class="hljs-keyword">int</span> start, <span class="hljs-keyword">int</span> finish, <span class="hljs-keyword">boolean</span> excludeLastState)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (start == UNDEFINED || finish == UNDEFINED) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Can&#x27;t resolve lifecycle path for undefined state&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (start == ON_RESTART || finish == ON_RESTART) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<br>                    <span class="hljs-string">&quot;Can&#x27;t start or finish in intermittent RESTART state&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (finish == PRE_ON_CREATE &amp;&amp; start != finish) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Can only start in pre-onCreate state&quot;</span>);<br>        &#125;<br><br>        mLifecycleSequence.clear();<br>        <span class="hljs-comment">// Activity 启动 时，执行到这里的 start 状态为 ON_CREATE，结束状态为 ON_RESUME</span><br>        <span class="hljs-keyword">if</span> (finish &gt;= start) &#123;<br>            <span class="hljs-keyword">if</span> (start == ON_START &amp;&amp; finish == ON_STOP) &#123;<br>                <span class="hljs-comment">// A case when we from start to stop state soon, we don&#x27;t need to go</span><br>                <span class="hljs-comment">// through the resumed, paused state.</span><br>                mLifecycleSequence.add(ON_STOP);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 会走到这里的逻辑，将 ON_START 与 ON_RESUME 添加到数组</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = start + <span class="hljs-number">1</span>; i &lt;= finish; i++) &#123;<br>                    mLifecycleSequence.add(i);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// finish &lt; start, can&#x27;t just cycle down</span><br>            <span class="hljs-keyword">if</span> (start == ON_PAUSE &amp;&amp; finish == ON_RESUME) &#123;<br>                <span class="hljs-comment">// Special case when we can just directly go to resumed state.</span><br>                mLifecycleSequence.add(ON_RESUME);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (start &lt;= ON_STOP &amp;&amp; finish &gt;= ON_START) &#123;<br>                <span class="hljs-comment">// Restart and go to required state.</span><br><br>                <span class="hljs-comment">// Go to stopped state first.</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = start + <span class="hljs-number">1</span>; i &lt;= ON_STOP; i++) &#123;<br>                    mLifecycleSequence.add(i);<br>                &#125;<br>                <span class="hljs-comment">// Restart</span><br>                mLifecycleSequence.add(ON_RESTART);<br>                <span class="hljs-comment">// Go to required state</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = ON_START; i &lt;= finish; i++) &#123;<br>                    mLifecycleSequence.add(i);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// Relaunch and go to required state</span><br><br>                <span class="hljs-comment">// Go to destroyed state first.</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = start + <span class="hljs-number">1</span>; i &lt;= ON_DESTROY; i++) &#123;<br>                    mLifecycleSequence.add(i);<br>                &#125;<br>                <span class="hljs-comment">// Go to required state</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = ON_CREATE; i &lt;= finish; i++) &#123;<br>                    mLifecycleSequence.add(i);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// Remove last transition in case we want to perform it with some specific params.</span><br>        <span class="hljs-keyword">if</span> (excludeLastState &amp;&amp; mLifecycleSequence.size() != <span class="hljs-number">0</span>) &#123;<br>            mLifecycleSequence.remove(mLifecycleSequence.size() - <span class="hljs-number">1</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> mLifecycleSequence;<br>    &#125;<br></code></pre></td></tr></table></figure>


<p>根据上边分析，此时的 start 为 ON_CREATE（值为 1），而 finish 的值为 ON_RESUME(值为 2)。因此，执行完 getLifecyclePath 后，会得到一个包含了 ON_START 与 ON_RESUME 的数组。</p>
<p>接下来看<code>performLifecycleSequence</code> 中的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/** Transition the client through previously initialized state sequence. */</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">performLifecycleSequence</span><span class="hljs-params">(ActivityClientRecord r, IntArray path,</span></span><br><span class="hljs-function"><span class="hljs-params">        ClientTransaction transaction)</span> </span>&#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> size = path.size();<br>    <span class="hljs-comment">// 遍历数组，执行 Activity 的生命周</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, state; i &lt; size; i++) &#123;<br>        state = path.get(i);<br><br>        <span class="hljs-keyword">switch</span> (state) &#123;<br>            <span class="hljs-keyword">case</span> ON_CREATE:<br>                mTransactionHandler.handleLaunchActivity(r, mPendingActions,<br>                        <span class="hljs-keyword">null</span> <span class="hljs-comment">/* customIntent */</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> ON_START:<br>                mTransactionHandler.handleStartActivity(r, mPendingActions,<br>                        <span class="hljs-keyword">null</span> <span class="hljs-comment">/* activityOptions */</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> ON_RESUME:<br>                mTransactionHandler.handleResumeActivity(r, <span class="hljs-keyword">false</span> <span class="hljs-comment">/* finalStateRequest */</span>,<br>                        r.isForward, <span class="hljs-string">&quot;LIFECYCLER_RESUME_ACTIVITY&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> ON_PAUSE:<br>                mTransactionHandler.handlePauseActivity(r, <span class="hljs-keyword">false</span> <span class="hljs-comment">/* finished */</span>,<br>                        <span class="hljs-keyword">false</span> <span class="hljs-comment">/* userLeaving */</span>, <span class="hljs-number">0</span> <span class="hljs-comment">/* configChanges */</span>,<br>                        <span class="hljs-keyword">false</span> <span class="hljs-comment">/* autoEnteringPip */</span>, mPendingActions,<br>                        <span class="hljs-string">&quot;LIFECYCLER_PAUSE_ACTIVITY&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> ON_STOP:<br>                mTransactionHandler.handleStopActivity(r, <span class="hljs-number">0</span> <span class="hljs-comment">/* configChanges */</span>,<br>                        mPendingActions, <span class="hljs-keyword">false</span> <span class="hljs-comment">/* finalStateRequest */</span>,<br>                        <span class="hljs-string">&quot;LIFECYCLER_STOP_ACTIVITY&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> ON_DESTROY:<br>                mTransactionHandler.handleDestroyActivity(r, <span class="hljs-keyword">false</span> <span class="hljs-comment">/* finishing */</span>,<br>                        <span class="hljs-number">0</span> <span class="hljs-comment">/* configChanges */</span>, <span class="hljs-keyword">false</span> <span class="hljs-comment">/* getNonConfigInstance */</span>,<br>                        <span class="hljs-string">&quot;performLifecycleSequence. cycling to:&quot;</span> + path.get(size - <span class="hljs-number">1</span>));<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> ON_RESTART:<br>                mTransactionHandler.performRestartActivity(r, <span class="hljs-keyword">false</span> <span class="hljs-comment">/* start */</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Unexpected lifecycle state: &quot;</span> + state);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在 <code>performLifecycleSequence</code> 方法中则是遍历了这个数组。因为此时的数组中有只有 ON_START 与 ON_RESUME 两个值，因此，这里分别先后执行了 <code>mTransactionHandler.handleStartActivity</code> 与 <code>mTransactionHandler.handleResumeActivity</code>，即调用了 ApplicationThread 的 handleStartActivity 与 handleResumeActivity 来执行 Activity 的 onStart 与 onResume 的生命周期。</p>
<h2 id="五、Activity-的创建与生命周期的执行"><a href="#五、Activity-的创建与生命周期的执行" class="headerlink" title="五、Activity 的创建与生命周期的执行"></a>五、Activity 的创建与生命周期的执行</h2><p>通过前面几个章节的分析我们已经知道，Activity 的启动是在服务端通过添加一个 LaunchActivityItem 到 ClientTransaction 中实现的，然后通过 IApplicationThread 跨进程将 ClientTransaction 传到了客户端来执行的。客户端通过遍历 ClientTransaction 中的所有 ClientTransactionItem，并执行了它的 execute 方法进而来执行 Activity 的创建过程。那接下来我们就来看一下 LaunchActivityItem 的 execute 方法调用后到底是如何执行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// frameworks/base/core/java/android/app/servertransaction/LaunchActivityItem.java</span><br><br><span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(ClientTransactionHandler client, IBinder token,</span></span><br><span class="hljs-function"><span class="hljs-params">            PendingTransactionActions pendingActions)</span> </span>&#123;<br>        <br>        ActivityClientRecord r = <span class="hljs-keyword">new</span> ActivityClientRecord(token, mIntent, mIdent, mInfo,<br>                mOverrideConfig, mCompatInfo, mReferrer, mVoiceInteractor, mState, mPersistentState,<br>                mPendingResults, mPendingNewIntents, mActivityOptions, mIsForward, mProfilerInfo,<br>                client, mAssistToken, mShareableActivityToken, mLaunchedFromBubble,<br>                mTaskFragmentToken);<br>                <br>        client.handleLaunchActivity(r, pendingActions, <span class="hljs-keyword">null</span> <span class="hljs-comment">/* customIntent */</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>LaunchActivityItem 的 execute 方法调用了 ClientTransactionHandler 的 <code>handleLaunchActivity</code>，而这里的 ClientTransactionHandler 就是 ActivityThread。 ActivityThread 中 handleLaunchActivity 的源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// frameworks/base/core/java/android/app/ActivityThread.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Activity <span class="hljs-title">handleLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r,</span></span><br><span class="hljs-function"><span class="hljs-params">            PendingTransactionActions pendingActions, Intent customIntent)</span> </span>&#123;<br>        <span class="hljs-comment">// If we are getting ready to gc after going to the background, well</span><br>        <span class="hljs-comment">// we are back active so skip it.</span><br>        unscheduleGcIdler();<br>        mSomeActivitiesChanged = <span class="hljs-keyword">true</span>;<br><br>        <span class="hljs-comment">// ...</span><br><br>        <span class="hljs-comment">// 初始化 WindowManagerGlobal</span><br>        WindowManagerGlobal.initialize();<br><br>       <br>        <span class="hljs-comment">// 调用 performLaunchActivity 执行 Activity 的创建流程</span><br>        <span class="hljs-keyword">final</span> Activity a = performLaunchActivity(r, customIntent);<br><br>        <span class="hljs-comment">// ...</span><br><br>        <span class="hljs-keyword">return</span> a;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>在 handleLaunchActivity 方法中首先去初始化了 WindowManagerGlobal，紧接着调用了 performLaunchActivity 并返回了一个 Activity 实例，那么 Activity 的实例化必定是在  performLaunchActivity 中完成的。</p>
<h3 id="1-Activity-的实例化与-onCreate-的调用"><a href="#1-Activity-的实例化与-onCreate-的调用" class="headerlink" title="1. Activity 的实例化与 onCreate 的调用"></a>1. Activity 的实例化与 onCreate 的调用</h3><p>看下 performLaunchActivity 的源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// frameworks/base/core/java/android/app/ActivityThread.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">private</span> Activity <span class="hljs-title">performLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;<br>        ActivityInfo aInfo = r.activityInfo;<br>        <span class="hljs-comment">// ...</span><br><br>        ContextImpl appContext = createBaseContextForActivity(r);<br>        Activity activity = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 在 Instrumentation 中通过反射实例化 Activity </span><br>            java.lang.ClassLoader cl = appContext.getClassLoader();<br>            activity = mInstrumentation.newActivity(<br>                    cl, component.getClassName(), r.intent);<br>            StrictMode.incrementExpectedActivityCount(activity.getClass());<br>            r.intent.setExtrasClassLoader(cl);<br>            r.intent.prepareToEnterProcess(isProtectedComponent(r.activityInfo),<br>                    appContext.getAttributionSource());<br>            <span class="hljs-keyword">if</span> (r.state != <span class="hljs-keyword">null</span>) &#123;<br>                r.state.setClassLoader(cl);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<br>                    <span class="hljs-string">&quot;Unable to instantiate activity &quot;</span> + component<br>                    + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>            &#125;<br>        &#125;<br><br>       <span class="hljs-comment">// ... 省略后半部分执行 Activity 生命周期的代码</span><br><br>        <span class="hljs-keyword">return</span> activity;<br>    &#125;<br><br></code></pre></td></tr></table></figure>
<p>这个方法中的主要逻辑可以分为两部分，第一部分是实例化 Activity；第二部分是执行 Activity 的 onCreate 的生命周期。由于代码比较长，这里我们只截取了第一部分的代码。可以看到这里通过 Instrumentation 的 newActivity 获取到一个 Activity 实例，newActivity 的参数传入了一个 ClassLoader 和 Activity 的 className。因此，这里实例化 Activity 的过程一定是通过反射实现的。看代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Activity <span class="hljs-title">newActivity</span><span class="hljs-params">(Class&lt;?&gt; clazz, Context context, </span></span><br><span class="hljs-function"><span class="hljs-params">        IBinder token, Application application, Intent intent, ActivityInfo info, </span></span><br><span class="hljs-function"><span class="hljs-params">        CharSequence title, Activity parent, String id,</span></span><br><span class="hljs-function"><span class="hljs-params">        Object lastNonConfigurationInstance)</span> <span class="hljs-keyword">throws</span> InstantiationException,</span><br><span class="hljs-function">        IllegalAccessException </span>&#123;<br>    Activity activity = (Activity)clazz.newInstance();<br>    ActivityThread aThread = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-comment">// Activity.attach expects a non-null Application Object.</span><br>    <span class="hljs-keyword">if</span> (application == <span class="hljs-keyword">null</span>) &#123;<br>        application = <span class="hljs-keyword">new</span> Application();<br>    &#125;<br>    activity.attach(context, aThread, <span class="hljs-keyword">this</span>, token, <span class="hljs-number">0</span> <span class="hljs-comment">/* ident */</span>, application, intent,<br>            info, title, parent, id,<br>            (Activity.NonConfigurationInstances)lastNonConfigurationInstance,<br>            <span class="hljs-keyword">new</span> Configuration(), <span class="hljs-keyword">null</span> <span class="hljs-comment">/* referrer */</span>, <span class="hljs-keyword">null</span> <span class="hljs-comment">/* voiceInteractor */</span>,<br>            <span class="hljs-keyword">null</span> <span class="hljs-comment">/* window */</span>, <span class="hljs-keyword">null</span> <span class="hljs-comment">/* activityCallback */</span>, <span class="hljs-keyword">null</span> <span class="hljs-comment">/*assistToken*/</span>,<br>            <span class="hljs-keyword">null</span> <span class="hljs-comment">/*shareableActivityToken*/</span>);<br>    <span class="hljs-keyword">return</span> activity;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>newActivity 中通过反射实例化了 Activity，接着调用了 Activity 的 attach 方法。</p>
<p>接下来看 performLaunchActivity 方法的后半部分的逻辑。在实例化了 Activity 之后是如何调用 Activity 的 onCreate 生命周期的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-function"><span class="hljs-keyword">private</span> Activity <span class="hljs-title">performLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;<br>        ActivityInfo aInfo = r.activityInfo;<br>        <span class="hljs-comment">// ...</span><br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 获取 Application </span><br>            Application app = r.packageInfo.makeApplicationInner(<span class="hljs-keyword">false</span>, mInstrumentation);<br><br>            <span class="hljs-comment">// ...</span><br><br>            <span class="hljs-keyword">if</span> (activity != <span class="hljs-keyword">null</span>) &#123;<br>                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());<br>                Configuration config =<br>                        <span class="hljs-keyword">new</span> Configuration(mConfigurationController.getCompatConfiguration());<br>                <span class="hljs-comment">// ...</span><br><br>                <span class="hljs-comment">// Activity resources must be initialized with the same loaders as the</span><br>                <span class="hljs-comment">// application context.</span><br>                appContext.getResources().addLoaders(<br>                        app.getResources().getLoaders().toArray(<span class="hljs-keyword">new</span> ResourcesLoader[<span class="hljs-number">0</span>]));<br><br>                appContext.setOuterContext(activity);<br>                <span class="hljs-comment">// 再次执行 Activity 的 attach 方法</span><br>                activity.attach(appContext, <span class="hljs-keyword">this</span>, getInstrumentation(), r.token,<br>                        r.ident, app, r.intent, r.activityInfo, title, r.parent,<br>                        r.embeddedID, r.lastNonConfigurationInstances, config,<br>                        r.referrer, r.voiceInteractor, window, r.activityConfigCallback,<br>                        r.assistToken, r.shareableActivityToken);<br><br>                <span class="hljs-keyword">if</span> (customIntent != <span class="hljs-keyword">null</span>) &#123;<br>                    activity.mIntent = customIntent;<br>                &#125;<br>                r.lastNonConfigurationInstances = <span class="hljs-keyword">null</span>;<br>                checkAndBlockForNetworkAccess();<br>                activity.mStartedActivity = <span class="hljs-keyword">false</span>;<br>                <span class="hljs-keyword">int</span> theme = r.activityInfo.getThemeResource();<br>                <span class="hljs-keyword">if</span> (theme != <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">// 设置 Activity 主题</span><br>                    activity.setTheme(theme);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (r.mActivityOptions != <span class="hljs-keyword">null</span>) &#123;<br>                    activity.mPendingOptions = r.mActivityOptions;<br>                    r.mActivityOptions = <span class="hljs-keyword">null</span>;<br>                &#125;<br>                activity.mLaunchedFromBubble = r.mLaunchedFromBubble;<br>                activity.mCalled = <span class="hljs-keyword">false</span>;<br>                <span class="hljs-comment">// Assigning the activity to the record before calling onCreate() allows</span><br>                <span class="hljs-comment">// ActivityThread#getActivity() lookup for the callbacks triggered from</span><br>                <span class="hljs-comment">// ActivityLifecycleCallbacks#onActivityCreated() or</span><br>                <span class="hljs-comment">// ActivityLifecycleCallback#onActivityPostCreated().</span><br>                r.activity = activity;<br>                <span class="hljs-comment">// 调用 Activity 的 onCreate 方法</span><br>                <span class="hljs-keyword">if</span> (r.isPersistable()) &#123;<br>                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    mInstrumentation.callActivityOnCreate(activity, r.state);<br>                &#125;<br>                <span class="hljs-comment">// ...</span><br>            &#125;<br>            r.setState(ON_CREATE);<br><br>        &#125; <span class="hljs-keyword">catch</span> (SuperNotCalledException e) &#123;<br>           <span class="hljs-comment">// ...</span><br>        &#125; <br><br>        <span class="hljs-keyword">return</span> activity;<br>    &#125;<br><br></code></pre></td></tr></table></figure>
<p>上述方法中首先获取 Activity 的 title 以及 Configuration 等相关参数，然后再次调用 Activity 的 attach 方法，并将这些参数传入。接着通过 Instrumentation 执行了 Activity 的 performCreate 方法，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">callActivityOnCreate</span><span class="hljs-params">(Activity activity, Bundle icicle)</span> </span>&#123;<br>    prePerformCreate(activity);<br>    activity.performCreate(icicle);<br>    postPerformCreate(activity);<br>&#125;<br><br><br></code></pre></td></tr></table></figure>
<p>而 Activity 的 performCreate 方法中最终会调用 Activity 的 onCreate方法。至此，我们在 Activity 的 onCreate 方法中写的逻辑才会被调用。performCreate 方法的代码这里就不再贴出，有兴趣的可以自行查看。</p>
<h3 id="2-onStart-方法的执行"><a href="#2-onStart-方法的执行" class="headerlink" title="2. onStart 方法的执行"></a>2. onStart 方法的执行</h3><p>在第四章的第 3 小节中，中我们已经分析了创建完 Activity 后如何执行后续的生命周期流程。我们知道 onStart 是通过 ActivityThread 的 handleStartActivity 来执行的，其源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/ActivityThread.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleStartActivity</span><span class="hljs-params">(ActivityClientRecord r,</span></span><br><span class="hljs-function"><span class="hljs-params">            PendingTransactionActions pendingActions, ActivityOptions activityOptions)</span> </span>&#123;<br>        <span class="hljs-keyword">final</span> Activity activity = r.activity;<br>        <span class="hljs-keyword">if</span> (!r.stopped) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Can&#x27;t start activity that is not stopped.&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (r.activity.mFinished) &#123;<br>            <span class="hljs-comment">// TODO(lifecycler): How can this happen?</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        unscheduleGcIdler();<br>        <span class="hljs-keyword">if</span> (activityOptions != <span class="hljs-keyword">null</span>) &#123;<br>            activity.mPendingOptions = activityOptions;<br>        &#125;<br><br>        <span class="hljs-comment">// 调用 Activity 的 performStart 进而执行 onStart</span><br>        activity.performStart(<span class="hljs-string">&quot;handleStartActivity&quot;</span>);<br>        <br>        <span class="hljs-comment">// 将生命周状态设置为 ON_START</span><br>        r.setState(ON_START);<br><br>       <span class="hljs-comment">// ...</span><br>    &#125;<br></code></pre></td></tr></table></figure>
<p>handleStartActivity 的逻辑比较简单，就是调用了 Activity 的 performStart 方法，进而调用了 onStart 方法。这里也不再贴出 performStart 方法的源码，感兴趣的同学自行查看。</p>
<h3 id="3-onResume-方法的调用"><a href="#3-onResume-方法的调用" class="headerlink" title="3. onResume 方法的调用"></a>3. onResume 方法的调用</h3><p>onResume 方法是通过 ActivityThread 的 handleResumeActivity 来执行的，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/ActivityThread.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleResumeActivity</span><span class="hljs-params">(ActivityClientRecord r, <span class="hljs-keyword">boolean</span> finalStateRequest,</span></span><br><span class="hljs-function"><span class="hljs-params">            <span class="hljs-keyword">boolean</span> isForward, <span class="hljs-keyword">boolean</span> shouldSendCompatFakeFocus, String reason)</span> </span>&#123;<br>        <span class="hljs-comment">// If we are getting ready to gc after going to the background, well</span><br>        <span class="hljs-comment">// we are back active so skip it.</span><br>        unscheduleGcIdler();<br>        mSomeActivitiesChanged = <span class="hljs-keyword">true</span>;<br><br>        <span class="hljs-comment">// TODO Push resumeArgs into the activity for consideration</span><br>        <span class="hljs-comment">// skip below steps for double-resume and r.mFinish = true case.</span><br>        <span class="hljs-keyword">if</span> (!performResumeActivity(r, finalStateRequest, reason)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <br>       <span class="hljs-comment">// ... 省略 Window 的添加逻辑</span><br>    &#125;<br></code></pre></td></tr></table></figure>
<p>handleResumeActivity 方法中的逻辑比较复杂，但核心主要有两点：</p>
<ul>
<li>调用 performResumeActivity 执行 onResume 的生命周期</li>
<li>将 DecorView 添加到 Window 中</li>
</ul>
<p>上述代码中我们省略了 decorView 添加到 Window 部分的代码，后边再来分析。先来看 performResumeActivity，其源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">performResumeActivity</span><span class="hljs-params">(ActivityClientRecord r, <span class="hljs-keyword">boolean</span> finalStateRequest,</span></span><br><span class="hljs-function"><span class="hljs-params">           String reason)</span> </span>&#123;<br>       <br>       <span class="hljs-keyword">if</span> (r.activity.mFinished) &#123;<br>           <span class="hljs-comment">// 如果 Activity 已经是finish状态，直接return false</span><br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>       &#125;<br>       <span class="hljs-keyword">if</span> (r.getLifecycleState() == ON_RESUME) &#123;<br>           <span class="hljs-comment">// 如果已经是 Resume 状态 直接return false，避免重复执行</span><br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>       &#125;<br><br>       <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">// ...</span><br>          <br>           <span class="hljs-comment">// 执行 Activity 的 performResume 进而执行 onResume</span><br>           r.activity. performResume(r.startsNotResumed, reason);<br><br>           r.state = <span class="hljs-keyword">null</span>;<br>           r.persistentState = <span class="hljs-keyword">null</span>;<br>           <span class="hljs-comment">// 设置 Activity 的状态 为 ON_RESUME</span><br>           r.setState(ON_RESUME);<br><br>           reportTopResumedActivityChanged(r, r.isTopResumedActivity, <span class="hljs-string">&quot;topWhenResuming&quot;</span>);<br>       &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>           <span class="hljs-keyword">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;<br>               <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;Unable to resume activity &quot;</span><br>                       + r.intent.getComponent().toShortString() + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>           &#125;<br>       &#125;<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>   &#125;<br><br></code></pre></td></tr></table></figure>
<p>performResumeActivity 中先对 Activity 的状态进行了判断，如果状态符合，则会调用 Activity 的 performResume 方法，进而执行 Activity 的 onResume。performResume 方法的源码不再贴出。</p>
<p>在完成了 performResume 的调用后，performResumeActivity 方法中接着执行了将 DecorView 添加到 Window 的过。代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// frameworks/base/core/java/android/app/ActivityThread.java</span><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleResumeActivity</span><span class="hljs-params">(ActivityClientRecord r, <span class="hljs-keyword">boolean</span> finalStateRequest,</span></span><br><span class="hljs-function"><span class="hljs-params">            <span class="hljs-keyword">boolean</span> isForward, <span class="hljs-keyword">boolean</span> shouldSendCompatFakeFocus, String reason)</span> </span>&#123;<br>        <span class="hljs-comment">// ...</span><br>        <br><br>        <span class="hljs-keyword">final</span> Activity a = r.activity;<br><br>        <span class="hljs-keyword">if</span> (r.window == <span class="hljs-keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;<br>            <span class="hljs-comment">// PhoneWindow</span><br>            r.window = r.activity.getWindow();<br>            <span class="hljs-comment">// 获取 DecorView</span><br>            View decor = r.window.getDecorView();<br>            <span class="hljs-comment">// 先设置 DecorView 不可见</span><br>            decor.setVisibility(View.INVISIBLE);<br>            <span class="hljs-comment">// 获取 WindowManager</span><br>            ViewManager wm = a.getWindowManager();<br>            <span class="hljs-comment">// 获取 Window 的属性参数</span><br>            WindowManager.LayoutParams l = r.window.getAttributes();<br>            a.mDecor = decor;<br>            l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;<br>            l.softInputMode |= forwardBit;<br>            <span class="hljs-comment">// ...</span><br>            <span class="hljs-keyword">if</span> (a.mVisibleFromClient) &#123;<br>                <span class="hljs-keyword">if</span> (!a.mWindowAdded) &#123;<br>                    a.mWindowAdded = <span class="hljs-keyword">true</span>;<br>                    <span class="hljs-comment">// 通过 WindowManager 将 DecorView添加到窗口</span><br>                    wm.addView(decor, l);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// The activity will get a callback for this &#123;@link LayoutParams&#125; change</span><br>                    <span class="hljs-comment">// earlier. However, at that time the decor will not be set (this is set</span><br>                    <span class="hljs-comment">// in this method), so no action will be taken. This call ensures the</span><br>                    <span class="hljs-comment">// callback occurs with the decor set.</span><br>                    a.onWindowAttributesChanged(l);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// If the window has already been added, but during resume</span><br>            <span class="hljs-comment">// we started another activity, then don&#x27;t yet make the</span><br>            <span class="hljs-comment">// window visible.</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!willBeVisible) &#123;<br>            <span class="hljs-keyword">if</span> (localLOGV) Slog.v(TAG, <span class="hljs-string">&quot;Launch &quot;</span> + r + <span class="hljs-string">&quot; mStartedActivity set&quot;</span>);<br>            r.hideForNow = <span class="hljs-keyword">true</span>;<br>        &#125;<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br></code></pre></td></tr></table></figure>
<p>可以看到，上述方法的的核心是 <code>wm.addView(decor, l)</code> 这行代码，即通过 ViewManager 的 addView 方法将 DecorView 添加到了窗口中。窗口的添加过程会完成 DecorView 的布局、测量与绘制。当完成窗口的添加后 Activity 的 View 才被显示出来，且有了宽高。这也是为什么我们在 onResume 中获取不到 View 宽高的原因。</p>
<p>另外需要注意到是，将 View 添加到 Window 的过程也是一个相当复杂的过程，这个过程也多次涉及到跨进程调用。这也是为什么在本文的开头提到 Activity 启动是一个数次跨进程调用的过程的原因。关于 Window 的添加过程，这里就不再赘述了，后边会单独写一篇文章来详细分析 Window 的添加。</p>
<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>通过本篇文章我们详细的了解了 Activity 的启动流程，虽然在开发中启动一个 Activity 只需要我们调用一行代码，但通过追踪源码我们发现 startActivity 方法的调用栈非常深，且中间涉及了两次跨进程的调用，如果不了解 Binder 与 AIDL 是比较难以读懂的。另外，由于 Activity 的启动过程比较复杂，文章中不能面面俱到，忽略了很多支线逻辑，比如当启动 Activity 时，Activity 所在的进程不存在时的逻辑，本文章并没有去分析，感兴趣的同学可以自行查看源码。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Framework/">Framework</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！ <div class="text-center"> <div class="about-info"> <div class="about-icons" style="margin-top:20px;"> <a target="_blank" rel="noopener" href="https://github.com/zhpanvip" class="hint--bottom hint--rounded" aria-label=GitHub> <i class="iconfont icon-github-fill" aria-hidden="true"></i> </a> <a target="_blank" rel="noopener" href="https://juejin.im/user/2735240659359448/posts" class="hint--bottom hint--rounded" aria-label=掘金> <i class="iconfont icon-juejin" aria-hidden="true"></i> </a> <a href="mailto:zhpanvip@outlook.com" class="hint--bottom hint--rounded" aria-label=邮箱> <i class="iconfont icon-mail" aria-hidden="true"></i> </a> <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_20521573" class="qr-trigger"> <i class="iconfont icon-wechat-fill" aria-hidden="true"></i> <img class="qr-img" src="https://raw.githubusercontent.com/zhpanvip/images/master/project/group/wechat_gzh.jpg" srcset="/img/loading.gif" alt="qrcode" /> </a> </div> </div></p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/20/50-android-architecture/">
                        <span class="hidden-mobile">Android 架构思想与 MVVM 框架封装</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <script type="text/javascript">
    Fluid.utils.waitElementVisible('comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'zhpanvip/utterances-comment');
      s.setAttribute('issue-term', 'title');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="https://raw.githubusercontent.com/zhpanvip/images/master/project/group/wechat_gzh.jpg" srcset="/img/loading.gif" class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <span rel="nofollow noopener">Copyright © 2016-<span id="current_year"><a target="_blank" href="https://github.com/zhpanvip" rel="nofollow noopener noopener"></span> ZhangPan</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a>
<script type="text/javascript"> function setCurrentYear() { var date = new Date(); var currentYear = date.getFullYear(); document.getElementById("current_year").innerHTML = currentYear; }
window.onload=function(){ setCurrentYear(); } </script>

  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>






  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
